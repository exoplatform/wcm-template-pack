<?xml version="1.0" encoding="UTF-8"?><bootstrap.js xmlns:nt="http://www.jcp.org/jcr/nt/1.0" xmlns:xcmis="http://www.exoplatform.com/jcr/xcmis/1.0" xmlns:tkn="http://www.gatein.org/jcr/token/1.0/" xmlns:webdav="http://www.exoplatform.org/jcr/webdav" xmlns:gtn="http://www.gatein.org/jcr/gatein/1.0/" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:plf="http://www.exoplatform.org/jcr/plf/1.0/" xmlns:jcr="http://www.jcp.org/jcr/1.0" xmlns:wsrp="http://www.gatein.org/jcr/wsrp/1.0/" xmlns:sv="http://www.jcp.org/jcr/sv/1.0" xmlns:ntf="http://www.gatein.org/jcr/ntf/1.0/" xmlns:wiki="http://exoplatform.org/wiki/1.0/" xmlns:jos="http://www.exoplatform.com/jcr-services/organization-service/1.0/" xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:metadata="http://www.exoplatform.com/jcr/metadata/1.1/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:app="http://www.gatein.org/jcr/application-registry/1.0/" xmlns:exoide="http://exoplatform.org/ide/1.1.x/" xmlns:stg="http://www.gatein.org/jcr/stg/1.0/" xmlns:cmis="http://www.exoplatform.com/jcr/cmis/1.0" xmlns:acme="http://www.exoplatform.com/plf/acme/4.0/" xmlns:lgn="http://www.gatein.org/jcr/autologin/1.0/" xmlns:mop="http://www.gatein.org/jcr/mop/1.0/" xmlns:fn_old="http://www.w3.org/2004/10/xpath-functions" xmlns:mix="http://www.jcp.org/jcr/mix/1.0" xmlns:publication="http://www.exoplatform.com/jcr/publication/1.1/" xmlns:exo="http://www.exoplatform.com/jcr/exo/1.0" xmlns:pc="http://www.gatein.org/jcr/pc/1.0/" xmlns:wai="http://www.exoplatform.com/ecm/accessibility/1.0" xmlns:soc="http://www.exoplatform.org/jcr/soc/1.0/" xmlns:portlet="http://www.gatein.org/jcr/portlet/1.0/" xmlns:rep="internal" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" jcr:primaryType="nt:file" jcr:mixinTypes="exo:sortable exo:owneable mix:referenceable exo:modify exo:jsFile exo:datetime mix:commentable mix:votable mix:i18n publication:authoring publication:authoringPublication mix:versionable exo:activityInfo" jcr:uuid="9f2fc2587f00000116ba325db9e86beb" exo:active="true" exo:activityId="9f2fc2a57f00000128f58bd21dd350f6" exo:dateCreated="2015-05-29T17:20:16.864+07:00" exo:dateModified="2015-05-29T17:20:16.925+07:00" exo:index="1000" exo:language="en" exo:lastModifiedDate="2015-05-29T17:20:17.292+07:00" exo:lastModifier="root" exo:name="bootstrap.js" exo:owner="root" exo:presentationType="exo:jsFile" exo:priority="0" exo:sharedJS="true" exo:title="bootstrap.js" exo:voteTotal="0" exo:voteTotalOfLang="0" exo:votingRate="0.0" publication:currentState="draft" publication:history="bootstrap.js;enrolled;root;2015-05-29T17:20:16.923+07:00;Publication.log.description.enrolled bootstrap.js;draft;root;2015-05-29T17:20:16.924+07:00;PublicationService.AuthoringPublicationPlugin.changeState.draft" publication:lastUser="root" publication:lifecycle="lifecycle1" publication:lifecycleName="Authoring_x0020_publication" publication:revisionData="9f2fc2587f00000116ba325db9e86beb,draft,root" jcr:baseVersion="9f2fc29a7f0000010fc531576d4c4ed3" jcr:created="2015-05-29T17:20:16.857+07:00" jcr:isCheckedOut="true" jcr:predecessors="9f2fc29a7f0000010fc531576d4c4ed3" jcr:versionHistory="9f2fc29a7f0000010446006accf486fd"><jcr:content jcr:primaryType="nt:resource" jcr:mixinTypes="exo:owneable exo:datetime dc:elementSet" jcr:uuid="9f2fc2867f0000015139fa6f17458a6f" exo:dateCreated="2015-05-29T17:20:16.903+07:00" exo:dateModified="2015-05-29T17:20:16.903+07:00" exo:internalUse="false" exo:owner="root" jcr:data="CgohZnVuY3Rpb24gKCQpIHsKCiAgInVzZSBzdHJpY3QiOyAvLyBqc2hpbnQgO187CgoKICAvKiBDU1MgVFJBTlNJVElPTiBTVVBQT1JUIChodHRwOi8vd3d3Lm1vZGVybml6ci5jb20vKQogICAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgJChmdW5jdGlvbiAoKSB7CgogICAgJC5zdXBwb3J0LnRyYW5zaXRpb24gPSAoZnVuY3Rpb24gKCkgewoKICAgICAgdmFyIHRyYW5zaXRpb25FbmQgPSAoZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdib290c3RyYXAnKQogICAgICAgICAgLCB0cmFuc0VuZEV2ZW50TmFtZXMgPSB7CiAgICAgICAgICAgICAgICdXZWJraXRUcmFuc2l0aW9uJyA6ICd3ZWJraXRUcmFuc2l0aW9uRW5kJwogICAgICAgICAgICAsICAnTW96VHJhbnNpdGlvbicgICAgOiAndHJhbnNpdGlvbmVuZCcKICAgICAgICAgICAgLCAgJ09UcmFuc2l0aW9uJyAgICAgIDogJ29UcmFuc2l0aW9uRW5kIG90cmFuc2l0aW9uZW5kJwogICAgICAgICAgICAsICAndHJhbnNpdGlvbicgICAgICAgOiAndHJhbnNpdGlvbmVuZCcKICAgICAgICAgICAgfQogICAgICAgICAgLCBuYW1lCgogICAgICAgIGZvciAobmFtZSBpbiB0cmFuc0VuZEV2ZW50TmFtZXMpewogICAgICAgICAgaWYgKGVsLnN0eWxlW25hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRyYW5zRW5kRXZlbnROYW1lc1tuYW1lXQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgIH0oKSkKCiAgICAgIHJldHVybiB0cmFuc2l0aW9uRW5kICYmIHsKICAgICAgICBlbmQ6IHRyYW5zaXRpb25FbmQKICAgICAgfQoKICAgIH0pKCkKCiAgfSkKCn0od2luZG93LmpRdWVyeSk7LyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBib290c3RyYXAtYWxlcnQuanMgdjIuMy4xCiAqIGh0dHA6Ly90d2l0dGVyLmdpdGh1Yi5jb20vYm9vdHN0cmFwL2phdmFzY3JpcHQuaHRtbCNhbGVydHMKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDb3B5cmlnaHQgMjAxMiBUd2l0dGVyLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKCiFmdW5jdGlvbiAoJCkgewoKICAidXNlIHN0cmljdCI7IC8vIGpzaGludCA7XzsKCgogLyogQUxFUlQgQ0xBU1MgREVGSU5JVElPTgogICogPT09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgZGlzbWlzcyA9ICdbZGF0YS1kaXNtaXNzPSJhbGVydCJdJwogICAgLCBBbGVydCA9IGZ1bmN0aW9uIChlbCkgewogICAgICAgICQoZWwpLm9uKCdjbGljaycsIGRpc21pc3MsIHRoaXMuY2xvc2UpCiAgICAgIH0KCiAgQWxlcnQucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciAkdGhpcyA9ICQodGhpcykKICAgICAgLCBzZWxlY3RvciA9ICR0aGlzLmF0dHIoJ2RhdGEtdGFyZ2V0JykKICAgICAgLCAkcGFyZW50CgogICAgaWYgKCFzZWxlY3RvcikgewogICAgICBzZWxlY3RvciA9ICR0aGlzLmF0dHIoJ2hyZWYnKQogICAgICBzZWxlY3RvciA9IHNlbGVjdG9yICYmIHNlbGVjdG9yLnJlcGxhY2UoLy4qKD89I1teXHNdKiQpLywgJycpIC8vc3RyaXAgZm9yIGllNwogICAgfQoKICAgICRwYXJlbnQgPSAkKHNlbGVjdG9yKQoKICAgIGUgJiYgZS5wcmV2ZW50RGVmYXVsdCgpCgogICAgJHBhcmVudC5sZW5ndGggfHwgKCRwYXJlbnQgPSAkdGhpcy5oYXNDbGFzcygnYWxlcnQnKSA/ICR0aGlzIDogJHRoaXMucGFyZW50KCkpCgogICAgJHBhcmVudC50cmlnZ2VyKGUgPSAkLkV2ZW50KCdjbG9zZScpKQoKICAgIGlmIChlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4KCiAgICAkcGFyZW50LnJlbW92ZUNsYXNzKCdpbicpCgogICAgZnVuY3Rpb24gcmVtb3ZlRWxlbWVudCgpIHsKICAgICAgJHBhcmVudAogICAgICAgIC50cmlnZ2VyKCdjbG9zZWQnKQogICAgICAgIC5yZW1vdmUoKQogICAgfQoKICAgICQuc3VwcG9ydC50cmFuc2l0aW9uICYmICRwYXJlbnQuaGFzQ2xhc3MoJ2ZhZGUnKSA/CiAgICAgICRwYXJlbnQub24oJC5zdXBwb3J0LnRyYW5zaXRpb24uZW5kLCByZW1vdmVFbGVtZW50KSA6CiAgICAgIHJlbW92ZUVsZW1lbnQoKQogIH0KCgogLyogQUxFUlQgUExVR0lOIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PT09ICovCgogIHZhciBvbGQgPSAkLmZuLmFsZXJ0CgogICQuZm4uYWxlcnQgPSBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyICR0aGlzID0gJCh0aGlzKQogICAgICAgICwgZGF0YSA9ICR0aGlzLmRhdGEoJ2FsZXJ0JykKICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCdhbGVydCcsIChkYXRhID0gbmV3IEFsZXJ0KHRoaXMpKSkKICAgICAgaWYgKHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycpIGRhdGFbb3B0aW9uXS5jYWxsKCR0aGlzKQogICAgfSkKICB9CgogICQuZm4uYWxlcnQuQ29uc3RydWN0b3IgPSBBbGVydAoKCiAvKiBBTEVSVCBOTyBDT05GTElDVAogICogPT09PT09PT09PT09PT09PT0gKi8KCiAgJC5mbi5hbGVydC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgJC5mbi5hbGVydCA9IG9sZAogICAgcmV0dXJuIHRoaXMKICB9CgoKIC8qIEFMRVJUIERBVEEtQVBJCiAgKiA9PT09PT09PT09PT09PSAqLwoKICAkKGRvY3VtZW50KS5vbignY2xpY2suYWxlcnQuZGF0YS1hcGknLCBkaXNtaXNzLCBBbGVydC5wcm90b3R5cGUuY2xvc2UpCgp9KHdpbmRvdy5qUXVlcnkpOy8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBib290c3RyYXAtYnV0dG9uLmpzIHYyLjMuMQogKiBodHRwOi8vdHdpdHRlci5naXRodWIuY29tL2Jvb3RzdHJhcC9qYXZhc2NyaXB0Lmh0bWwjYnV0dG9ucwogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogQ29weXJpZ2h0IDIwMTIgVHdpdHRlciwgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKCiFmdW5jdGlvbiAoJCkgewoKICAidXNlIHN0cmljdCI7IC8vIGpzaGludCA7XzsKCgogLyogQlVUVE9OIFBVQkxJQyBDTEFTUyBERUZJTklUSU9OCiAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIEJ1dHRvbiA9IGZ1bmN0aW9uIChlbGVtZW50LCBvcHRpb25zKSB7CiAgICB0aGlzLiRlbGVtZW50ID0gJChlbGVtZW50KQogICAgdGhpcy5vcHRpb25zID0gJC5leHRlbmQoe30sICQuZm4uYnV0dG9uLmRlZmF1bHRzLCBvcHRpb25zKQogIH0KCiAgQnV0dG9uLnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkgewogICAgdmFyIGQgPSAnZGlzYWJsZWQnCiAgICAgICwgJGVsID0gdGhpcy4kZWxlbWVudAogICAgICAsIGRhdGEgPSAkZWwuZGF0YSgpCiAgICAgICwgdmFsID0gJGVsLmlzKCdpbnB1dCcpID8gJ3ZhbCcgOiAnaHRtbCcKCiAgICBzdGF0ZSA9IHN0YXRlICsgJ1RleHQnCiAgICBkYXRhLnJlc2V0VGV4dCB8fCAkZWwuZGF0YSgncmVzZXRUZXh0JywgJGVsW3ZhbF0oKSkKCiAgICAkZWxbdmFsXShkYXRhW3N0YXRlXSB8fCB0aGlzLm9wdGlvbnNbc3RhdGVdKQoKICAgIC8vIHB1c2ggdG8gZXZlbnQgbG9vcCB0byBhbGxvdyBmb3JtcyB0byBzdWJtaXQKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBzdGF0ZSA9PSAnbG9hZGluZ1RleHQnID8KICAgICAgICAkZWwuYWRkQ2xhc3MoZCkuYXR0cihkLCBkKSA6CiAgICAgICAgJGVsLnJlbW92ZUNsYXNzKGQpLnJlbW92ZUF0dHIoZCkKICAgIH0sIDApCiAgfQoKICBCdXR0b24ucHJvdG90eXBlLnRvZ2dsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciAkcGFyZW50ID0gdGhpcy4kZWxlbWVudC5jbG9zZXN0KCdbZGF0YS10b2dnbGU9ImJ1dHRvbnMtcmFkaW8iXScpCgogICAgJHBhcmVudCAmJiAkcGFyZW50CiAgICAgIC5maW5kKCcuYWN0aXZlJykKICAgICAgLnJlbW92ZUNsYXNzKCdhY3RpdmUnKQoKICAgIHRoaXMuJGVsZW1lbnQudG9nZ2xlQ2xhc3MoJ2FjdGl2ZScpCiAgfQoKCiAvKiBCVVRUT04gUExVR0lOIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgb2xkID0gJC5mbi5idXR0b24KCiAgJC5mbi5idXR0b24gPSBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyICR0aGlzID0gJCh0aGlzKQogICAgICAgICwgZGF0YSA9ICR0aGlzLmRhdGEoJ2J1dHRvbicpCiAgICAgICAgLCBvcHRpb25zID0gdHlwZW9mIG9wdGlvbiA9PSAnb2JqZWN0JyAmJiBvcHRpb24KICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCdidXR0b24nLCAoZGF0YSA9IG5ldyBCdXR0b24odGhpcywgb3B0aW9ucykpKQogICAgICBpZiAob3B0aW9uID09ICd0b2dnbGUnKSBkYXRhLnRvZ2dsZSgpCiAgICAgIGVsc2UgaWYgKG9wdGlvbikgZGF0YS5zZXRTdGF0ZShvcHRpb24pCiAgICB9KQogIH0KCiAgJC5mbi5idXR0b24uZGVmYXVsdHMgPSB7CiAgICBsb2FkaW5nVGV4dDogJ2xvYWRpbmcuLi4nCiAgfQoKICAkLmZuLmJ1dHRvbi5Db25zdHJ1Y3RvciA9IEJ1dHRvbgoKCiAvKiBCVVRUT04gTk8gQ09ORkxJQ1QKICAqID09PT09PT09PT09PT09PT09PSAqLwoKICAkLmZuLmJ1dHRvbi5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgJC5mbi5idXR0b24gPSBvbGQKICAgIHJldHVybiB0aGlzCiAgfQoKCiAvKiBCVVRUT04gREFUQS1BUEkKICAqID09PT09PT09PT09PT09PSAqLwoKICAkKGRvY3VtZW50KS5vbignY2xpY2suYnV0dG9uLmRhdGEtYXBpJywgJ1tkYXRhLXRvZ2dsZV49YnV0dG9uXScsIGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgJGJ0biA9ICQoZS50YXJnZXQpCiAgICBpZiAoISRidG4uaGFzQ2xhc3MoJ2J0bicpKSAkYnRuID0gJGJ0bi5jbG9zZXN0KCcuYnRuJykKICAgICRidG4uYnV0dG9uKCd0b2dnbGUnKQogIH0pCgp9KHdpbmRvdy5qUXVlcnkpOy8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogYm9vdHN0cmFwLWNhcm91c2VsLmpzIHYyLjMuMQogKiBodHRwOi8vdHdpdHRlci5naXRodWIuY29tL2Jvb3RzdHJhcC9qYXZhc2NyaXB0Lmh0bWwjY2Fyb3VzZWwKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDb3B5cmlnaHQgMjAxMiBUd2l0dGVyLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKCiFmdW5jdGlvbiAoJCkgewoKICAidXNlIHN0cmljdCI7IC8vIGpzaGludCA7XzsKCgogLyogQ0FST1VTRUwgQ0xBU1MgREVGSU5JVElPTgogICogPT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgQ2Fyb3VzZWwgPSBmdW5jdGlvbiAoZWxlbWVudCwgb3B0aW9ucykgewogICAgdGhpcy4kZWxlbWVudCA9ICQoZWxlbWVudCkKICAgIHRoaXMuJGluZGljYXRvcnMgPSB0aGlzLiRlbGVtZW50LmZpbmQoJy5jYXJvdXNlbC1pbmRpY2F0b3JzJykKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMKICAgIHRoaXMub3B0aW9ucy5wYXVzZSA9PSAnaG92ZXInICYmIHRoaXMuJGVsZW1lbnQKICAgICAgLm9uKCdtb3VzZWVudGVyJywgJC5wcm94eSh0aGlzLnBhdXNlLCB0aGlzKSkKICAgICAgLm9uKCdtb3VzZWxlYXZlJywgJC5wcm94eSh0aGlzLmN5Y2xlLCB0aGlzKSkKICB9CgogIENhcm91c2VsLnByb3RvdHlwZSA9IHsKCiAgICBjeWNsZTogZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKCFlKSB0aGlzLnBhdXNlZCA9IGZhbHNlCiAgICAgIGlmICh0aGlzLmludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpOwogICAgICB0aGlzLm9wdGlvbnMuaW50ZXJ2YWwKICAgICAgICAmJiAhdGhpcy5wYXVzZWQKICAgICAgICAmJiAodGhpcy5pbnRlcnZhbCA9IHNldEludGVydmFsKCQucHJveHkodGhpcy5uZXh0LCB0aGlzKSwgdGhpcy5vcHRpb25zLmludGVydmFsKSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0KCiAgLCBnZXRBY3RpdmVJbmRleDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLiRhY3RpdmUgPSB0aGlzLiRlbGVtZW50LmZpbmQoJy5pdGVtLmFjdGl2ZScpCiAgICAgIHRoaXMuJGl0ZW1zID0gdGhpcy4kYWN0aXZlLnBhcmVudCgpLmNoaWxkcmVuKCkKICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLmluZGV4KHRoaXMuJGFjdGl2ZSkKICAgIH0KCiAgLCB0bzogZnVuY3Rpb24gKHBvcykgewogICAgICB2YXIgYWN0aXZlSW5kZXggPSB0aGlzLmdldEFjdGl2ZUluZGV4KCkKICAgICAgICAsIHRoYXQgPSB0aGlzCgogICAgICBpZiAocG9zID4gKHRoaXMuJGl0ZW1zLmxlbmd0aCAtIDEpIHx8IHBvcyA8IDApIHJldHVybgoKICAgICAgaWYgKHRoaXMuc2xpZGluZykgewogICAgICAgIHJldHVybiB0aGlzLiRlbGVtZW50Lm9uZSgnc2xpZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRoYXQudG8ocG9zKQogICAgICAgIH0pCiAgICAgIH0KCiAgICAgIGlmIChhY3RpdmVJbmRleCA9PSBwb3MpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXVzZSgpLmN5Y2xlKCkKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuc2xpZGUocG9zID4gYWN0aXZlSW5kZXggPyAnbmV4dCcgOiAncHJldicsICQodGhpcy4kaXRlbXNbcG9zXSkpCiAgICB9CgogICwgcGF1c2U6IGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmICghZSkgdGhpcy5wYXVzZWQgPSB0cnVlCiAgICAgIGlmICh0aGlzLiRlbGVtZW50LmZpbmQoJy5uZXh0LCAucHJldicpLmxlbmd0aCAmJiAkLnN1cHBvcnQudHJhbnNpdGlvbi5lbmQpIHsKICAgICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXIoJC5zdXBwb3J0LnRyYW5zaXRpb24uZW5kKQogICAgICAgIHRoaXMuY3ljbGUodHJ1ZSkKICAgICAgfQogICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpCiAgICAgIHRoaXMuaW50ZXJ2YWwgPSBudWxsCiAgICAgIHJldHVybiB0aGlzCiAgICB9CgogICwgbmV4dDogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5zbGlkaW5nKSByZXR1cm4KICAgICAgcmV0dXJuIHRoaXMuc2xpZGUoJ25leHQnKQogICAgfQoKICAsIHByZXY6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuc2xpZGluZykgcmV0dXJuCiAgICAgIHJldHVybiB0aGlzLnNsaWRlKCdwcmV2JykKICAgIH0KCiAgLCBzbGlkZTogZnVuY3Rpb24gKHR5cGUsIG5leHQpIHsKICAgICAgdmFyICRhY3RpdmUgPSB0aGlzLiRlbGVtZW50LmZpbmQoJy5pdGVtLmFjdGl2ZScpCiAgICAgICAgLCAkbmV4dCA9IG5leHQgfHwgJGFjdGl2ZVt0eXBlXSgpCiAgICAgICAgLCBpc0N5Y2xpbmcgPSB0aGlzLmludGVydmFsCiAgICAgICAgLCBkaXJlY3Rpb24gPSB0eXBlID09ICduZXh0JyA/ICdsZWZ0JyA6ICdyaWdodCcKICAgICAgICAsIGZhbGxiYWNrICA9IHR5cGUgPT0gJ25leHQnID8gJ2ZpcnN0JyA6ICdsYXN0JwogICAgICAgICwgdGhhdCA9IHRoaXMKICAgICAgICAsIGUKCiAgICAgIHRoaXMuc2xpZGluZyA9IHRydWUKCiAgICAgIGlzQ3ljbGluZyAmJiB0aGlzLnBhdXNlKCkKCiAgICAgICRuZXh0ID0gJG5leHQubGVuZ3RoID8gJG5leHQgOiB0aGlzLiRlbGVtZW50LmZpbmQoJy5pdGVtJylbZmFsbGJhY2tdKCkKCiAgICAgIGUgPSAkLkV2ZW50KCdzbGlkZScsIHsKICAgICAgICByZWxhdGVkVGFyZ2V0OiAkbmV4dFswXQogICAgICAsIGRpcmVjdGlvbjogZGlyZWN0aW9uCiAgICAgIH0pCgogICAgICBpZiAoJG5leHQuaGFzQ2xhc3MoJ2FjdGl2ZScpKSByZXR1cm4KCiAgICAgIGlmICh0aGlzLiRpbmRpY2F0b3JzLmxlbmd0aCkgewogICAgICAgIHRoaXMuJGluZGljYXRvcnMuZmluZCgnLmFjdGl2ZScpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKQogICAgICAgIHRoaXMuJGVsZW1lbnQub25lKCdzbGlkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyICRuZXh0SW5kaWNhdG9yID0gJCh0aGF0LiRpbmRpY2F0b3JzLmNoaWxkcmVuKClbdGhhdC5nZXRBY3RpdmVJbmRleCgpXSkKICAgICAgICAgICRuZXh0SW5kaWNhdG9yICYmICRuZXh0SW5kaWNhdG9yLmFkZENsYXNzKCdhY3RpdmUnKQogICAgICAgIH0pCiAgICAgIH0KCiAgICAgIGlmICgkLnN1cHBvcnQudHJhbnNpdGlvbiAmJiB0aGlzLiRlbGVtZW50Lmhhc0NsYXNzKCdzbGlkZScpKSB7CiAgICAgICAgdGhpcy4kZWxlbWVudC50cmlnZ2VyKGUpCiAgICAgICAgaWYgKGUuaXNEZWZhdWx0UHJldmVudGVkKCkpIHJldHVybgogICAgICAgICRuZXh0LmFkZENsYXNzKHR5cGUpCiAgICAgICAgJG5leHRbMF0ub2Zmc2V0V2lkdGggLy8gZm9yY2UgcmVmbG93CiAgICAgICAgJGFjdGl2ZS5hZGRDbGFzcyhkaXJlY3Rpb24pCiAgICAgICAgJG5leHQuYWRkQ2xhc3MoZGlyZWN0aW9uKQogICAgICAgIHRoaXMuJGVsZW1lbnQub25lKCQuc3VwcG9ydC50cmFuc2l0aW9uLmVuZCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgJG5leHQucmVtb3ZlQ2xhc3MoW3R5cGUsIGRpcmVjdGlvbl0uam9pbignICcpKS5hZGRDbGFzcygnYWN0aXZlJykKICAgICAgICAgICRhY3RpdmUucmVtb3ZlQ2xhc3MoWydhY3RpdmUnLCBkaXJlY3Rpb25dLmpvaW4oJyAnKSkKICAgICAgICAgIHRoYXQuc2xpZGluZyA9IGZhbHNlCiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgdGhhdC4kZWxlbWVudC50cmlnZ2VyKCdzbGlkJykgfSwgMCkKICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcihlKQogICAgICAgIGlmIChlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4KICAgICAgICAkYWN0aXZlLnJlbW92ZUNsYXNzKCdhY3RpdmUnKQogICAgICAgICRuZXh0LmFkZENsYXNzKCdhY3RpdmUnKQogICAgICAgIHRoaXMuc2xpZGluZyA9IGZhbHNlCiAgICAgICAgdGhpcy4kZWxlbWVudC50cmlnZ2VyKCdzbGlkJykKICAgICAgfQoKICAgICAgaXNDeWNsaW5nICYmIHRoaXMuY3ljbGUoKQoKICAgICAgcmV0dXJuIHRoaXMKICAgIH0KCiAgfQoKCiAvKiBDQVJPVVNFTCBQTFVHSU4gREVGSU5JVElPTgogICogPT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIG9sZCA9ICQuZm4uY2Fyb3VzZWwKCiAgJC5mbi5jYXJvdXNlbCA9IGZ1bmN0aW9uIChvcHRpb24pIHsKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpCiAgICAgICAgLCBkYXRhID0gJHRoaXMuZGF0YSgnY2Fyb3VzZWwnKQogICAgICAgICwgb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCAkLmZuLmNhcm91c2VsLmRlZmF1bHRzLCB0eXBlb2Ygb3B0aW9uID09ICdvYmplY3QnICYmIG9wdGlvbikKICAgICAgICAsIGFjdGlvbiA9IHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycgPyBvcHRpb24gOiBvcHRpb25zLnNsaWRlCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnY2Fyb3VzZWwnLCAoZGF0YSA9IG5ldyBDYXJvdXNlbCh0aGlzLCBvcHRpb25zKSkpCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9uID09ICdudW1iZXInKSBkYXRhLnRvKG9wdGlvbikKICAgICAgZWxzZSBpZiAoYWN0aW9uKSBkYXRhW2FjdGlvbl0oKQogICAgICBlbHNlIGlmIChvcHRpb25zLmludGVydmFsKSBkYXRhLnBhdXNlKCkuY3ljbGUoKQogICAgfSkKICB9CgogICQuZm4uY2Fyb3VzZWwuZGVmYXVsdHMgPSB7CiAgICBpbnRlcnZhbDogNTAwMAogICwgcGF1c2U6ICdob3ZlcicKICB9CgogICQuZm4uY2Fyb3VzZWwuQ29uc3RydWN0b3IgPSBDYXJvdXNlbAoKCiAvKiBDQVJPVVNFTCBOTyBDT05GTElDVAogICogPT09PT09PT09PT09PT09PT09PT0gKi8KCiAgJC5mbi5jYXJvdXNlbC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgJC5mbi5jYXJvdXNlbCA9IG9sZAogICAgcmV0dXJuIHRoaXMKICB9CgogLyogQ0FST1VTRUwgREFUQS1BUEkKICAqID09PT09PT09PT09PT09PT09ICovCgogICQoZG9jdW1lbnQpLm9uKCdjbGljay5jYXJvdXNlbC5kYXRhLWFwaScsICdbZGF0YS1zbGlkZV0sIFtkYXRhLXNsaWRlLXRvXScsIGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgJHRoaXMgPSAkKHRoaXMpLCBocmVmCiAgICAgICwgJHRhcmdldCA9ICQoJHRoaXMuYXR0cignZGF0YS10YXJnZXQnKSB8fCAoaHJlZiA9ICR0aGlzLmF0dHIoJ2hyZWYnKSkgJiYgaHJlZi5yZXBsYWNlKC8uKig/PSNbXlxzXSskKS8sICcnKSkgLy9zdHJpcCBmb3IgaWU3CiAgICAgICwgb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCAkdGFyZ2V0LmRhdGEoKSwgJHRoaXMuZGF0YSgpKQogICAgICAsIHNsaWRlSW5kZXgKCiAgICAkdGFyZ2V0LmNhcm91c2VsKG9wdGlvbnMpCgogICAgaWYgKHNsaWRlSW5kZXggPSAkdGhpcy5hdHRyKCdkYXRhLXNsaWRlLXRvJykpIHsKICAgICAgJHRhcmdldC5kYXRhKCdjYXJvdXNlbCcpLnBhdXNlKCkudG8oc2xpZGVJbmRleCkuY3ljbGUoKQogICAgfQoKICAgIGUucHJldmVudERlZmF1bHQoKQogIH0pCgp9KHdpbmRvdy5qUXVlcnkpOy8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogYm9vdHN0cmFwLWNvbGxhcHNlLmpzIHYyLjMuMQogKiBodHRwOi8vdHdpdHRlci5naXRodWIuY29tL2Jvb3RzdHJhcC9qYXZhc2NyaXB0Lmh0bWwjY29sbGFwc2UKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDb3B5cmlnaHQgMjAxMiBUd2l0dGVyLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgoKIWZ1bmN0aW9uICgkKSB7CgogICJ1c2Ugc3RyaWN0IjsgLy8ganNoaW50IDtfOwoKCiAvKiBDT0xMQVBTRSBQVUJMSUMgQ0xBU1MgREVGSU5JVElPTgogICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIENvbGxhcHNlID0gZnVuY3Rpb24gKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgIHRoaXMuJGVsZW1lbnQgPSAkKGVsZW1lbnQpCiAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgJC5mbi5jb2xsYXBzZS5kZWZhdWx0cywgb3B0aW9ucykKCiAgICBpZiAodGhpcy5vcHRpb25zLnBhcmVudCkgewogICAgICB0aGlzLiRwYXJlbnQgPSAkKHRoaXMub3B0aW9ucy5wYXJlbnQpCiAgICB9CgogICAgdGhpcy5vcHRpb25zLnRvZ2dsZSAmJiB0aGlzLnRvZ2dsZSgpCiAgfQoKICBDb2xsYXBzZS5wcm90b3R5cGUgPSB7CgogICAgY29uc3RydWN0b3I6IENvbGxhcHNlCgogICwgZGltZW5zaW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBoYXNXaWR0aCA9IHRoaXMuJGVsZW1lbnQuaGFzQ2xhc3MoJ3dpZHRoJykKICAgICAgcmV0dXJuIGhhc1dpZHRoID8gJ3dpZHRoJyA6ICdoZWlnaHQnCiAgICB9CgogICwgc2hvdzogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZGltZW5zaW9uCiAgICAgICAgLCBzY3JvbGwKICAgICAgICAsIGFjdGl2ZXMKICAgICAgICAsIGhhc0RhdGEKCiAgICAgIGlmICh0aGlzLnRyYW5zaXRpb25pbmcgfHwgdGhpcy4kZWxlbWVudC5oYXNDbGFzcygnaW4nKSkgcmV0dXJuCgogICAgICBkaW1lbnNpb24gPSB0aGlzLmRpbWVuc2lvbigpCiAgICAgIHNjcm9sbCA9ICQuY2FtZWxDYXNlKFsnc2Nyb2xsJywgZGltZW5zaW9uXS5qb2luKCctJykpCiAgICAgIGFjdGl2ZXMgPSB0aGlzLiRwYXJlbnQgJiYgdGhpcy4kcGFyZW50LmZpbmQoJz4gLmFjY29yZGlvbi1ncm91cCA+IC5pbicpCgogICAgICBpZiAoYWN0aXZlcyAmJiBhY3RpdmVzLmxlbmd0aCkgewogICAgICAgIGhhc0RhdGEgPSBhY3RpdmVzLmRhdGEoJ2NvbGxhcHNlJykKICAgICAgICBpZiAoaGFzRGF0YSAmJiBoYXNEYXRhLnRyYW5zaXRpb25pbmcpIHJldHVybgogICAgICAgIGFjdGl2ZXMuY29sbGFwc2UoJ2hpZGUnKQogICAgICAgIGhhc0RhdGEgfHwgYWN0aXZlcy5kYXRhKCdjb2xsYXBzZScsIG51bGwpCiAgICAgIH0KCiAgICAgIHRoaXMuJGVsZW1lbnRbZGltZW5zaW9uXSgwKQogICAgICB0aGlzLnRyYW5zaXRpb24oJ2FkZENsYXNzJywgJC5FdmVudCgnc2hvdycpLCAnc2hvd24nKQogICAgICAkLnN1cHBvcnQudHJhbnNpdGlvbiAmJiB0aGlzLiRlbGVtZW50W2RpbWVuc2lvbl0odGhpcy4kZWxlbWVudFswXVtzY3JvbGxdKQogICAgfQoKICAsIGhpZGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGRpbWVuc2lvbgogICAgICBpZiAodGhpcy50cmFuc2l0aW9uaW5nIHx8ICF0aGlzLiRlbGVtZW50Lmhhc0NsYXNzKCdpbicpKSByZXR1cm4KICAgICAgZGltZW5zaW9uID0gdGhpcy5kaW1lbnNpb24oKQogICAgICB0aGlzLnJlc2V0KHRoaXMuJGVsZW1lbnRbZGltZW5zaW9uXSgpKQogICAgICB0aGlzLnRyYW5zaXRpb24oJ3JlbW92ZUNsYXNzJywgJC5FdmVudCgnaGlkZScpLCAnaGlkZGVuJykKICAgICAgdGhpcy4kZWxlbWVudFtkaW1lbnNpb25dKDApCiAgICB9CgogICwgcmVzZXQ6IGZ1bmN0aW9uIChzaXplKSB7CiAgICAgIHZhciBkaW1lbnNpb24gPSB0aGlzLmRpbWVuc2lvbigpCgogICAgICB0aGlzLiRlbGVtZW50CiAgICAgICAgLnJlbW92ZUNsYXNzKCdjb2xsYXBzZScpCiAgICAgICAgW2RpbWVuc2lvbl0oc2l6ZSB8fCAnYXV0bycpCiAgICAgICAgWzBdLm9mZnNldFdpZHRoCgogICAgICB0aGlzLiRlbGVtZW50W3NpemUgIT09IG51bGwgPyAnYWRkQ2xhc3MnIDogJ3JlbW92ZUNsYXNzJ10oJ2NvbGxhcHNlJykKCiAgICAgIHJldHVybiB0aGlzCiAgICB9CgogICwgdHJhbnNpdGlvbjogZnVuY3Rpb24gKG1ldGhvZCwgc3RhcnRFdmVudCwgY29tcGxldGVFdmVudCkgewogICAgICB2YXIgdGhhdCA9IHRoaXMKICAgICAgICAsIGNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoc3RhcnRFdmVudC50eXBlID09ICdzaG93JykgdGhhdC5yZXNldCgpCiAgICAgICAgICAgIHRoYXQudHJhbnNpdGlvbmluZyA9IDAKICAgICAgICAgICAgdGhhdC4kZWxlbWVudC50cmlnZ2VyKGNvbXBsZXRlRXZlbnQpCiAgICAgICAgICB9CgogICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXIoc3RhcnRFdmVudCkKCiAgICAgIGlmIChzdGFydEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4KCiAgICAgIHRoaXMudHJhbnNpdGlvbmluZyA9IDEKCiAgICAgIHRoaXMuJGVsZW1lbnRbbWV0aG9kXSgnaW4nKQoKICAgICAgJC5zdXBwb3J0LnRyYW5zaXRpb24gJiYgdGhpcy4kZWxlbWVudC5oYXNDbGFzcygnY29sbGFwc2UnKSA/CiAgICAgICAgdGhpcy4kZWxlbWVudC5vbmUoJC5zdXBwb3J0LnRyYW5zaXRpb24uZW5kLCBjb21wbGV0ZSkgOgogICAgICAgIGNvbXBsZXRlKCkKICAgIH0KCiAgLCB0b2dnbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpc1t0aGlzLiRlbGVtZW50Lmhhc0NsYXNzKCdpbicpID8gJ2hpZGUnIDogJ3Nob3cnXSgpCiAgICB9CgogIH0KCgogLyogQ09MTEFQU0UgUExVR0lOIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgogIHZhciBvbGQgPSAkLmZuLmNvbGxhcHNlCgogICQuZm4uY29sbGFwc2UgPSBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyICR0aGlzID0gJCh0aGlzKQogICAgICAgICwgZGF0YSA9ICR0aGlzLmRhdGEoJ2NvbGxhcHNlJykKICAgICAgICAsIG9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgJC5mbi5jb2xsYXBzZS5kZWZhdWx0cywgJHRoaXMuZGF0YSgpLCB0eXBlb2Ygb3B0aW9uID09ICdvYmplY3QnICYmIG9wdGlvbikKICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCdjb2xsYXBzZScsIChkYXRhID0gbmV3IENvbGxhcHNlKHRoaXMsIG9wdGlvbnMpKSkKICAgICAgaWYgKHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycpIGRhdGFbb3B0aW9uXSgpCiAgICB9KQogIH0KCiAgJC5mbi5jb2xsYXBzZS5kZWZhdWx0cyA9IHsKICAgIHRvZ2dsZTogdHJ1ZQogIH0KCiAgJC5mbi5jb2xsYXBzZS5Db25zdHJ1Y3RvciA9IENvbGxhcHNlCgoKIC8qIENPTExBUFNFIE5PIENPTkZMSUNUCiAgKiA9PT09PT09PT09PT09PT09PT09PSAqLwoKICAkLmZuLmNvbGxhcHNlLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICAkLmZuLmNvbGxhcHNlID0gb2xkCiAgICByZXR1cm4gdGhpcwogIH0KCgogLyogQ09MTEFQU0UgREFUQS1BUEkKICAqID09PT09PT09PT09PT09PT09ICovCgogICQoZG9jdW1lbnQpLm9uKCdjbGljay5jb2xsYXBzZS5kYXRhLWFwaScsICdbZGF0YS10b2dnbGU9Y29sbGFwc2VdJywgZnVuY3Rpb24gKGUpIHsKICAgIHZhciAkdGhpcyA9ICQodGhpcyksIGhyZWYKICAgICAgLCB0YXJnZXQgPSAkdGhpcy5hdHRyKCdkYXRhLXRhcmdldCcpCiAgICAgICAgfHwgZS5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgfHwgKGhyZWYgPSAkdGhpcy5hdHRyKCdocmVmJykpICYmIGhyZWYucmVwbGFjZSgvLiooPz0jW15cc10rJCkvLCAnJykgLy9zdHJpcCBmb3IgaWU3CiAgICAgICwgb3B0aW9uID0gJCh0YXJnZXQpLmRhdGEoJ2NvbGxhcHNlJykgPyAndG9nZ2xlJyA6ICR0aGlzLmRhdGEoKQogICAgJHRoaXNbJCh0YXJnZXQpLmhhc0NsYXNzKCdpbicpID8gJ2FkZENsYXNzJyA6ICdyZW1vdmVDbGFzcyddKCdjb2xsYXBzZWQnKQogICAgJCh0YXJnZXQpLmNvbGxhcHNlKG9wdGlvbikKICB9KQoKfSh3aW5kb3cualF1ZXJ5KTsvKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogYm9vdHN0cmFwLWRyb3Bkb3duLmpzIHYyLjMuMQogKiBodHRwOi8vdHdpdHRlci5naXRodWIuY29tL2Jvb3RzdHJhcC9qYXZhc2NyaXB0Lmh0bWwjZHJvcGRvd25zCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDb3B5cmlnaHQgMjAxMiBUd2l0dGVyLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgoKIWZ1bmN0aW9uICgkKSB7CgogICJ1c2Ugc3RyaWN0IjsgLy8ganNoaW50IDtfOwoKCiAvKiBEUk9QRE9XTiBDTEFTUyBERUZJTklUSU9OCiAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09ICovCgogIHZhciB0b2dnbGUgPSAnW2RhdGEtdG9nZ2xlPWRyb3Bkb3duXScKICAgICwgRHJvcGRvd24gPSBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgIHZhciAkZWwgPSAkKGVsZW1lbnQpLm9uKCdjbGljay5kcm9wZG93bi5kYXRhLWFwaScsIHRoaXMudG9nZ2xlKQogICAgICAgICQoJ2h0bWwnKS5vbignY2xpY2suZHJvcGRvd24uZGF0YS1hcGknLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAkZWwucGFyZW50KCkucmVtb3ZlQ2xhc3MoJ29wZW4nKQogICAgICAgIH0pCiAgICAgIH0KCiAgRHJvcGRvd24ucHJvdG90eXBlID0gewoKICAgIGNvbnN0cnVjdG9yOiBEcm9wZG93bgoKICAsIHRvZ2dsZTogZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyICR0aGlzID0gJCh0aGlzKQogICAgICAgICwgJHBhcmVudAogICAgICAgICwgaXNBY3RpdmUKCiAgICAgIGlmICgkdGhpcy5pcygnLmRpc2FibGVkLCA6ZGlzYWJsZWQnKSkgcmV0dXJuCgogICAgICAkcGFyZW50ID0gZ2V0UGFyZW50KCR0aGlzKQoKICAgICAgaXNBY3RpdmUgPSAkcGFyZW50Lmhhc0NsYXNzKCdvcGVuJykKCiAgICAgIGNsZWFyTWVudXMoKQoKICAgICAgaWYgKCFpc0FjdGl2ZSkgewogICAgICAgICRwYXJlbnQudG9nZ2xlQ2xhc3MoJ29wZW4nKQogICAgICB9CgogICAgICAkdGhpcy5mb2N1cygpCgogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgLCBrZXlkb3duOiBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgJHRoaXMKICAgICAgICAsICRpdGVtcwogICAgICAgICwgJGFjdGl2ZQogICAgICAgICwgJHBhcmVudAogICAgICAgICwgaXNBY3RpdmUKICAgICAgICAsIGluZGV4CgogICAgICBpZiAoIS8oMzh8NDB8MjcpLy50ZXN0KGUua2V5Q29kZSkpIHJldHVybgoKICAgICAgJHRoaXMgPSAkKHRoaXMpCgogICAgICBlLnByZXZlbnREZWZhdWx0KCkKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKQoKICAgICAgaWYgKCR0aGlzLmlzKCcuZGlzYWJsZWQsIDpkaXNhYmxlZCcpKSByZXR1cm4KCiAgICAgICRwYXJlbnQgPSBnZXRQYXJlbnQoJHRoaXMpCgogICAgICBpc0FjdGl2ZSA9ICRwYXJlbnQuaGFzQ2xhc3MoJ29wZW4nKQoKICAgICAgaWYgKCFpc0FjdGl2ZSB8fCAoaXNBY3RpdmUgJiYgZS5rZXlDb2RlID09IDI3KSkgewogICAgICAgIGlmIChlLndoaWNoID09IDI3KSAkcGFyZW50LmZpbmQodG9nZ2xlKS5mb2N1cygpCiAgICAgICAgcmV0dXJuICR0aGlzLmNsaWNrKCkKICAgICAgfQoKICAgICAgJGl0ZW1zID0gJCgnW3JvbGU9bWVudV0gbGk6bm90KC5kaXZpZGVyKTp2aXNpYmxlIGEnLCAkcGFyZW50KQoKICAgICAgaWYgKCEkaXRlbXMubGVuZ3RoKSByZXR1cm4KCiAgICAgIGluZGV4ID0gJGl0ZW1zLmluZGV4KCRpdGVtcy5maWx0ZXIoJzpmb2N1cycpKQoKICAgICAgaWYgKGUua2V5Q29kZSA9PSAzOCAmJiBpbmRleCA+IDApIGluZGV4LS0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXAKICAgICAgaWYgKGUua2V5Q29kZSA9PSA0MCAmJiBpbmRleCA8ICRpdGVtcy5sZW5ndGggLSAxKSBpbmRleCsrICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG93bgogICAgICBpZiAoIX5pbmRleCkgaW5kZXggPSAwCgogICAgICAkaXRlbXMKICAgICAgICAuZXEoaW5kZXgpCiAgICAgICAgLmZvY3VzKCkKICAgIH0KCiAgfQoKICBmdW5jdGlvbiBjbGVhck1lbnVzKCkgewogICAgJCh0b2dnbGUpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICBnZXRQYXJlbnQoJCh0aGlzKSkucmVtb3ZlQ2xhc3MoJ29wZW4nKQogICAgfSkKICB9CgogIGZ1bmN0aW9uIGdldFBhcmVudCgkdGhpcykgewogICAgdmFyIHNlbGVjdG9yID0gJHRoaXMuYXR0cignZGF0YS10YXJnZXQnKQogICAgICAsICRwYXJlbnQKCiAgICBpZiAoIXNlbGVjdG9yKSB7CiAgICAgIHNlbGVjdG9yID0gJHRoaXMuYXR0cignaHJlZicpCiAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3IgJiYgLyMvLnRlc3Qoc2VsZWN0b3IpICYmIHNlbGVjdG9yLnJlcGxhY2UoLy4qKD89I1teXHNdKiQpLywgJycpIC8vc3RyaXAgZm9yIGllNwogICAgfQoKICAgICRwYXJlbnQgPSBzZWxlY3RvciAmJiAkKHNlbGVjdG9yKQoKICAgIGlmICghJHBhcmVudCB8fCAhJHBhcmVudC5sZW5ndGgpICRwYXJlbnQgPSAkdGhpcy5wYXJlbnQoKQoKICAgIHJldHVybiAkcGFyZW50CiAgfQoKCiAgLyogRFJPUERPV04gUExVR0lOIERFRklOSVRJT04KICAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgb2xkID0gJC5mbi5kcm9wZG93bgoKICAkLmZuLmRyb3Bkb3duID0gZnVuY3Rpb24gKG9wdGlvbikgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciAkdGhpcyA9ICQodGhpcykKICAgICAgICAsIGRhdGEgPSAkdGhpcy5kYXRhKCdkcm9wZG93bicpCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnZHJvcGRvd24nLCAoZGF0YSA9IG5ldyBEcm9wZG93bih0aGlzKSkpCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9uID09ICdzdHJpbmcnKSBkYXRhW29wdGlvbl0uY2FsbCgkdGhpcykKICAgIH0pCiAgfQoKICAkLmZuLmRyb3Bkb3duLkNvbnN0cnVjdG9yID0gRHJvcGRvd24KCgogLyogRFJPUERPV04gTk8gQ09ORkxJQ1QKICAqID09PT09PT09PT09PT09PT09PT09ICovCgogICQuZm4uZHJvcGRvd24ubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgICQuZm4uZHJvcGRvd24gPSBvbGQKICAgIHJldHVybiB0aGlzCiAgfQoKCiAgLyogQVBQTFkgVE8gU1RBTkRBUkQgRFJPUERPV04gRUxFTUVOVFMKICAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKICAkKGRvY3VtZW50KQogICAgLm9uKCdjbGljay5kcm9wZG93bi5kYXRhLWFwaScsIGNsZWFyTWVudXMpCiAgICAub24oJ2NsaWNrLmRyb3Bkb3duLmRhdGEtYXBpJywgJy5kcm9wZG93biBmb3JtJywgZnVuY3Rpb24gKGUpIHsgZS5zdG9wUHJvcGFnYXRpb24oKSB9KQogICAgLm9uKCdjbGljay5kcm9wZG93bi1tZW51JywgZnVuY3Rpb24gKGUpIHsgZS5zdG9wUHJvcGFnYXRpb24oKSB9KQogICAgLm9uKCdjbGljay5kcm9wZG93bi5kYXRhLWFwaScgICwgdG9nZ2xlLCBEcm9wZG93bi5wcm90b3R5cGUudG9nZ2xlKQogICAgLm9uKCdrZXlkb3duLmRyb3Bkb3duLmRhdGEtYXBpJywgdG9nZ2xlICsgJywgW3JvbGU9bWVudV0nICwgRHJvcGRvd24ucHJvdG90eXBlLmtleWRvd24pCgp9KHdpbmRvdy5qUXVlcnkpOwovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogYm9vdHN0cmFwLW1vZGFsLmpzIHYyLjMuMQogKiBodHRwOi8vdHdpdHRlci5naXRodWIuY29tL2Jvb3RzdHJhcC9qYXZhc2NyaXB0Lmh0bWwjbW9kYWxzCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDb3B5cmlnaHQgMjAxMiBUd2l0dGVyLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgoKIWZ1bmN0aW9uICgkKSB7CgogICJ1c2Ugc3RyaWN0IjsgLy8ganNoaW50IDtfOwoKCiAvKiBNT0RBTCBDTEFTUyBERUZJTklUSU9OCiAgKiA9PT09PT09PT09PT09PT09PT09PT09ICovCgogIHZhciBNb2RhbCA9IGZ1bmN0aW9uIChlbGVtZW50LCBvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zCiAgICB0aGlzLiRlbGVtZW50ID0gJChlbGVtZW50KQogICAgICAuZGVsZWdhdGUoJ1tkYXRhLWRpc21pc3M9Im1vZGFsIl0nLCAnY2xpY2suZGlzbWlzcy5tb2RhbCcsICQucHJveHkodGhpcy5oaWRlLCB0aGlzKSkKICAgIHRoaXMub3B0aW9ucy5yZW1vdGUgJiYgdGhpcy4kZWxlbWVudC5maW5kKCcubW9kYWwtYm9keScpLmxvYWQodGhpcy5vcHRpb25zLnJlbW90ZSkKICB9CgogIE1vZGFsLnByb3RvdHlwZSA9IHsKCiAgICAgIGNvbnN0cnVjdG9yOiBNb2RhbAoKICAgICwgdG9nZ2xlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbIXRoaXMuaXNTaG93biA/ICdzaG93JyA6ICdoaWRlJ10oKQogICAgICB9CgogICAgLCBzaG93OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzCiAgICAgICAgICAsIGUgPSAkLkV2ZW50KCdzaG93JykKCiAgICAgICAgdGhpcy4kZWxlbWVudC50cmlnZ2VyKGUpCgogICAgICAgIGlmICh0aGlzLmlzU2hvd24gfHwgZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgcmV0dXJuCgogICAgICAgIHRoaXMuaXNTaG93biA9IHRydWUKCiAgICAgICAgdGhpcy5lc2NhcGUoKQoKICAgICAgICB0aGlzLmJhY2tkcm9wKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uID0gJC5zdXBwb3J0LnRyYW5zaXRpb24gJiYgdGhhdC4kZWxlbWVudC5oYXNDbGFzcygnZmFkZScpCgogICAgICAgICAgaWYgKCF0aGF0LiRlbGVtZW50LnBhcmVudCgpLmxlbmd0aCkgewogICAgICAgICAgICB0aGF0LiRlbGVtZW50LmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpIC8vZG9uJ3QgbW92ZSBtb2RhbHMgZG9tIHBvc2l0aW9uCiAgICAgICAgICB9CgogICAgICAgICAgdGhhdC4kZWxlbWVudC5zaG93KCkKCiAgICAgICAgICBpZiAodHJhbnNpdGlvbikgewogICAgICAgICAgICB0aGF0LiRlbGVtZW50WzBdLm9mZnNldFdpZHRoIC8vIGZvcmNlIHJlZmxvdwogICAgICAgICAgfQoKICAgICAgICAgIHRoYXQuJGVsZW1lbnQKICAgICAgICAgICAgLmFkZENsYXNzKCdpbicpCiAgICAgICAgICAgIC5hdHRyKCdhcmlhLWhpZGRlbicsIGZhbHNlKQoKICAgICAgICAgIHRoYXQuZW5mb3JjZUZvY3VzKCkKCiAgICAgICAgICB0cmFuc2l0aW9uID8KICAgICAgICAgICAgdGhhdC4kZWxlbWVudC5vbmUoJC5zdXBwb3J0LnRyYW5zaXRpb24uZW5kLCBmdW5jdGlvbiAoKSB7IHRoYXQuJGVsZW1lbnQuZm9jdXMoKS50cmlnZ2VyKCdzaG93bicpIH0pIDoKICAgICAgICAgICAgdGhhdC4kZWxlbWVudC5mb2N1cygpLnRyaWdnZXIoJ3Nob3duJykKCiAgICAgICAgfSkKICAgICAgfQoKICAgICwgaGlkZTogZnVuY3Rpb24gKGUpIHsKICAgICAgICBlICYmIGUucHJldmVudERlZmF1bHQoKQoKICAgICAgICB2YXIgdGhhdCA9IHRoaXMKCiAgICAgICAgZSA9ICQuRXZlbnQoJ2hpZGUnKQoKICAgICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXIoZSkKCiAgICAgICAgaWYgKCF0aGlzLmlzU2hvd24gfHwgZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgcmV0dXJuCgogICAgICAgIHRoaXMuaXNTaG93biA9IGZhbHNlCgogICAgICAgIHRoaXMuZXNjYXBlKCkKCiAgICAgICAgJChkb2N1bWVudCkub2ZmKCdmb2N1c2luLm1vZGFsJykKCiAgICAgICAgdGhpcy4kZWxlbWVudAogICAgICAgICAgLnJlbW92ZUNsYXNzKCdpbicpCiAgICAgICAgICAuYXR0cignYXJpYS1oaWRkZW4nLCB0cnVlKQoKICAgICAgICAkLnN1cHBvcnQudHJhbnNpdGlvbiAmJiB0aGlzLiRlbGVtZW50Lmhhc0NsYXNzKCdmYWRlJykgPwogICAgICAgICAgdGhpcy5oaWRlV2l0aFRyYW5zaXRpb24oKSA6CiAgICAgICAgICB0aGlzLmhpZGVNb2RhbCgpCiAgICAgIH0KCiAgICAsIGVuZm9yY2VGb2N1czogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcwogICAgICAgICQoZG9jdW1lbnQpLm9uKCdmb2N1c2luLm1vZGFsJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIGlmICh0aGF0LiRlbGVtZW50WzBdICE9PSBlLnRhcmdldCAmJiAhdGhhdC4kZWxlbWVudC5oYXMoZS50YXJnZXQpLmxlbmd0aCkgewogICAgICAgICAgICB0aGF0LiRlbGVtZW50LmZvY3VzKCkKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9CgogICAgLCBlc2NhcGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMKICAgICAgICBpZiAodGhpcy5pc1Nob3duICYmIHRoaXMub3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgdGhpcy4kZWxlbWVudC5vbigna2V5dXAuZGlzbWlzcy5tb2RhbCcsIGZ1bmN0aW9uICggZSApIHsKICAgICAgICAgICAgZS53aGljaCA9PSAyNyAmJiB0aGF0LmhpZGUoKQogICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmlzU2hvd24pIHsKICAgICAgICAgIHRoaXMuJGVsZW1lbnQub2ZmKCdrZXl1cC5kaXNtaXNzLm1vZGFsJykKICAgICAgICB9CiAgICAgIH0KCiAgICAsIGhpZGVXaXRoVHJhbnNpdGlvbjogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcwogICAgICAgICAgLCB0aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdGhhdC4kZWxlbWVudC5vZmYoJC5zdXBwb3J0LnRyYW5zaXRpb24uZW5kKQogICAgICAgICAgICAgIHRoYXQuaGlkZU1vZGFsKCkKICAgICAgICAgICAgfSwgNTAwKQoKICAgICAgICB0aGlzLiRlbGVtZW50Lm9uZSgkLnN1cHBvcnQudHJhbnNpdGlvbi5lbmQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICAgICAgdGhhdC5oaWRlTW9kYWwoKQogICAgICAgIH0pCiAgICAgIH0KCiAgICAsIGhpZGVNb2RhbDogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcwogICAgICAgIHRoaXMuJGVsZW1lbnQuaGlkZSgpCiAgICAgICAgdGhpcy5iYWNrZHJvcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB0aGF0LnJlbW92ZUJhY2tkcm9wKCkKICAgICAgICAgIHRoYXQuJGVsZW1lbnQudHJpZ2dlcignaGlkZGVuJykKICAgICAgICB9KQogICAgICB9CgogICAgLCByZW1vdmVCYWNrZHJvcDogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuJGJhY2tkcm9wICYmIHRoaXMuJGJhY2tkcm9wLnJlbW92ZSgpCiAgICAgICAgdGhpcy4kYmFja2Ryb3AgPSBudWxsCiAgICAgIH0KCiAgICAsIGJhY2tkcm9wOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMKICAgICAgICAgICwgYW5pbWF0ZSA9IHRoaXMuJGVsZW1lbnQuaGFzQ2xhc3MoJ2ZhZGUnKSA/ICdmYWRlJyA6ICcnCgogICAgICAgIGlmICh0aGlzLmlzU2hvd24gJiYgdGhpcy5vcHRpb25zLmJhY2tkcm9wKSB7CiAgICAgICAgICB2YXIgZG9BbmltYXRlID0gJC5zdXBwb3J0LnRyYW5zaXRpb24gJiYgYW5pbWF0ZQoKICAgICAgICAgIHRoaXMuJGJhY2tkcm9wID0gJCgnPGRpdiBjbGFzcz0ibW9kYWwtYmFja2Ryb3AgJyArIGFuaW1hdGUgKyAnIiAvPicpCiAgICAgICAgICAgIC5hcHBlbmRUbyhkb2N1bWVudC5ib2R5KQoKICAgICAgICAgIHRoaXMuJGJhY2tkcm9wLmNsaWNrKAogICAgICAgICAgICB0aGlzLm9wdGlvbnMuYmFja2Ryb3AgPT0gJ3N0YXRpYycgPwogICAgICAgICAgICAgICQucHJveHkodGhpcy4kZWxlbWVudFswXS5mb2N1cywgdGhpcy4kZWxlbWVudFswXSkKICAgICAgICAgICAgOiAkLnByb3h5KHRoaXMuaGlkZSwgdGhpcykKICAgICAgICAgICkKCiAgICAgICAgICBpZiAoZG9BbmltYXRlKSB0aGlzLiRiYWNrZHJvcFswXS5vZmZzZXRXaWR0aCAvLyBmb3JjZSByZWZsb3cKCiAgICAgICAgICB0aGlzLiRiYWNrZHJvcC5hZGRDbGFzcygnaW4nKQoKICAgICAgICAgIGlmICghY2FsbGJhY2spIHJldHVybgoKICAgICAgICAgIGRvQW5pbWF0ZSA/CiAgICAgICAgICAgIHRoaXMuJGJhY2tkcm9wLm9uZSgkLnN1cHBvcnQudHJhbnNpdGlvbi5lbmQsIGNhbGxiYWNrKSA6CiAgICAgICAgICAgIGNhbGxiYWNrKCkKCiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5pc1Nob3duICYmIHRoaXMuJGJhY2tkcm9wKSB7CiAgICAgICAgICB0aGlzLiRiYWNrZHJvcC5yZW1vdmVDbGFzcygnaW4nKQoKICAgICAgICAgICQuc3VwcG9ydC50cmFuc2l0aW9uICYmIHRoaXMuJGVsZW1lbnQuaGFzQ2xhc3MoJ2ZhZGUnKT8KICAgICAgICAgICAgdGhpcy4kYmFja2Ryb3Aub25lKCQuc3VwcG9ydC50cmFuc2l0aW9uLmVuZCwgY2FsbGJhY2spIDoKICAgICAgICAgICAgY2FsbGJhY2soKQoKICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICBjYWxsYmFjaygpCiAgICAgICAgfQogICAgICB9CiAgfQoKCiAvKiBNT0RBTCBQTFVHSU4gREVGSU5JVElPTgogICogPT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIG9sZCA9ICQuZm4ubW9kYWwKCiAgJC5mbi5tb2RhbCA9IGZ1bmN0aW9uIChvcHRpb24pIHsKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpCiAgICAgICAgLCBkYXRhID0gJHRoaXMuZGF0YSgnbW9kYWwnKQogICAgICAgICwgb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCAkLmZuLm1vZGFsLmRlZmF1bHRzLCAkdGhpcy5kYXRhKCksIHR5cGVvZiBvcHRpb24gPT0gJ29iamVjdCcgJiYgb3B0aW9uKQogICAgICBpZiAoIWRhdGEpICR0aGlzLmRhdGEoJ21vZGFsJywgKGRhdGEgPSBuZXcgTW9kYWwodGhpcywgb3B0aW9ucykpKQogICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PSAnc3RyaW5nJykgZGF0YVtvcHRpb25dKCkKICAgICAgZWxzZSBpZiAob3B0aW9ucy5zaG93KSBkYXRhLnNob3coKQogICAgfSkKICB9CgogICQuZm4ubW9kYWwuZGVmYXVsdHMgPSB7CiAgICAgIGJhY2tkcm9wOiB0cnVlCiAgICAsIGtleWJvYXJkOiB0cnVlCiAgICAsIHNob3c6IHRydWUKICB9CgogICQuZm4ubW9kYWwuQ29uc3RydWN0b3IgPSBNb2RhbAoKCiAvKiBNT0RBTCBOTyBDT05GTElDVAogICogPT09PT09PT09PT09PT09PT0gKi8KCiAgJC5mbi5tb2RhbC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgJC5mbi5tb2RhbCA9IG9sZAogICAgcmV0dXJuIHRoaXMKICB9CgoKIC8qIE1PREFMIERBVEEtQVBJCiAgKiA9PT09PT09PT09PT09PSAqLwoKICAkKGRvY3VtZW50KS5vbignY2xpY2subW9kYWwuZGF0YS1hcGknLCAnW2RhdGEtdG9nZ2xlPSJtb2RhbCJdJywgZnVuY3Rpb24gKGUpIHsKICAgIHZhciAkdGhpcyA9ICQodGhpcykKICAgICAgLCBocmVmID0gJHRoaXMuYXR0cignaHJlZicpCiAgICAgICwgJHRhcmdldCA9ICQoJHRoaXMuYXR0cignZGF0YS10YXJnZXQnKSB8fCAoaHJlZiAmJiBocmVmLnJlcGxhY2UoLy4qKD89I1teXHNdKyQpLywgJycpKSkgLy9zdHJpcCBmb3IgaWU3CiAgICAgICwgb3B0aW9uID0gJHRhcmdldC5kYXRhKCdtb2RhbCcpID8gJ3RvZ2dsZScgOiAkLmV4dGVuZCh7IHJlbW90ZTohLyMvLnRlc3QoaHJlZikgJiYgaHJlZiB9LCAkdGFyZ2V0LmRhdGEoKSwgJHRoaXMuZGF0YSgpKQoKICAgIGUucHJldmVudERlZmF1bHQoKQoKICAgICR0YXJnZXQKICAgICAgLm1vZGFsKG9wdGlvbikKICAgICAgLm9uZSgnaGlkZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAkdGhpcy5mb2N1cygpCiAgICAgIH0pCiAgfSkKCn0od2luZG93LmpRdWVyeSk7Ci8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIGJvb3RzdHJhcC10b29sdGlwLmpzIHYyLjMuMQogKiBodHRwOi8vdHdpdHRlci5naXRodWIuY29tL2Jvb3RzdHJhcC9qYXZhc2NyaXB0Lmh0bWwjdG9vbHRpcHMKICogSW5zcGlyZWQgYnkgdGhlIG9yaWdpbmFsIGpRdWVyeS50aXBzeSBieSBKYXNvbiBGcmFtZQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDb3B5cmlnaHQgMjAxMiBUd2l0dGVyLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKCiFmdW5jdGlvbiAoJCkgewoKICAidXNlIHN0cmljdCI7IC8vIGpzaGludCA7XzsKCgogLyogVE9PTFRJUCBQVUJMSUMgQ0xBU1MgREVGSU5JVElPTgogICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgVG9vbHRpcCA9IGZ1bmN0aW9uIChlbGVtZW50LCBvcHRpb25zKSB7CiAgICB0aGlzLmluaXQoJ3Rvb2x0aXAnLCBlbGVtZW50LCBvcHRpb25zKQogIH0KCiAgVG9vbHRpcC5wcm90b3R5cGUgPSB7CgogICAgY29uc3RydWN0b3I6IFRvb2x0aXAKCiAgLCBpbml0OiBmdW5jdGlvbiAodHlwZSwgZWxlbWVudCwgb3B0aW9ucykgewogICAgICB2YXIgZXZlbnRJbgogICAgICAgICwgZXZlbnRPdXQKICAgICAgICAsIHRyaWdnZXJzCiAgICAgICAgLCB0cmlnZ2VyCiAgICAgICAgLCBpCgogICAgICB0aGlzLnR5cGUgPSB0eXBlCiAgICAgIHRoaXMuJGVsZW1lbnQgPSAkKGVsZW1lbnQpCiAgICAgIHRoaXMub3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9ucyhvcHRpb25zKQogICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlCgogICAgICB0cmlnZ2VycyA9IHRoaXMub3B0aW9ucy50cmlnZ2VyLnNwbGl0KCcgJykKCiAgICAgIGZvciAoaSA9IHRyaWdnZXJzLmxlbmd0aDsgaS0tOykgewogICAgICAgIHRyaWdnZXIgPSB0cmlnZ2Vyc1tpXQogICAgICAgIGlmICh0cmlnZ2VyID09ICdjbGljaycpIHsKICAgICAgICAgIHRoaXMuJGVsZW1lbnQub24oJ2NsaWNrLicgKyB0aGlzLnR5cGUsIHRoaXMub3B0aW9ucy5zZWxlY3RvciwgJC5wcm94eSh0aGlzLnRvZ2dsZSwgdGhpcykpCiAgICAgICAgfSBlbHNlIGlmICh0cmlnZ2VyICE9ICdtYW51YWwnKSB7CiAgICAgICAgICBldmVudEluID0gdHJpZ2dlciA9PSAnaG92ZXInID8gJ21vdXNlZW50ZXInIDogJ2ZvY3VzJwogICAgICAgICAgZXZlbnRPdXQgPSB0cmlnZ2VyID09ICdob3ZlcicgPyAnbW91c2VsZWF2ZScgOiAnYmx1cicKICAgICAgICAgIHRoaXMuJGVsZW1lbnQub24oZXZlbnRJbiArICcuJyArIHRoaXMudHlwZSwgdGhpcy5vcHRpb25zLnNlbGVjdG9yLCAkLnByb3h5KHRoaXMuZW50ZXIsIHRoaXMpKQogICAgICAgICAgdGhpcy4kZWxlbWVudC5vbihldmVudE91dCArICcuJyArIHRoaXMudHlwZSwgdGhpcy5vcHRpb25zLnNlbGVjdG9yLCAkLnByb3h5KHRoaXMubGVhdmUsIHRoaXMpKQogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5vcHRpb25zLnNlbGVjdG9yID8KICAgICAgICAodGhpcy5fb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCB0aGlzLm9wdGlvbnMsIHsgdHJpZ2dlcjogJ21hbnVhbCcsIHNlbGVjdG9yOiAnJyB9KSkgOgogICAgICAgIHRoaXMuZml4VGl0bGUoKQogICAgfQoKICAsIGdldE9wdGlvbnM6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgJC5mblt0aGlzLnR5cGVdLmRlZmF1bHRzLCB0aGlzLiRlbGVtZW50LmRhdGEoKSwgb3B0aW9ucykKCiAgICAgIGlmIChvcHRpb25zLmRlbGF5ICYmIHR5cGVvZiBvcHRpb25zLmRlbGF5ID09ICdudW1iZXInKSB7CiAgICAgICAgb3B0aW9ucy5kZWxheSA9IHsKICAgICAgICAgIHNob3c6IG9wdGlvbnMuZGVsYXkKICAgICAgICAsIGhpZGU6IG9wdGlvbnMuZGVsYXkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBvcHRpb25zCiAgICB9CgogICwgZW50ZXI6IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBkZWZhdWx0cyA9ICQuZm5bdGhpcy50eXBlXS5kZWZhdWx0cwogICAgICAgICwgb3B0aW9ucyA9IHt9CiAgICAgICAgLCBzZWxmCgogICAgICB0aGlzLl9vcHRpb25zICYmICQuZWFjaCh0aGlzLl9vcHRpb25zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChkZWZhdWx0c1trZXldICE9IHZhbHVlKSBvcHRpb25zW2tleV0gPSB2YWx1ZQogICAgICB9LCB0aGlzKQoKICAgICAgc2VsZiA9ICQoZS5jdXJyZW50VGFyZ2V0KVt0aGlzLnR5cGVdKG9wdGlvbnMpLmRhdGEodGhpcy50eXBlKQoKICAgICAgaWYgKCFzZWxmLm9wdGlvbnMuZGVsYXkgfHwgIXNlbGYub3B0aW9ucy5kZWxheS5zaG93KSByZXR1cm4gc2VsZi5zaG93KCkKCiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpCiAgICAgIHNlbGYuaG92ZXJTdGF0ZSA9ICdpbicKICAgICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBpZiAoc2VsZi5ob3ZlclN0YXRlID09ICdpbicpIHNlbGYuc2hvdygpCiAgICAgIH0sIHNlbGYub3B0aW9ucy5kZWxheS5zaG93KQogICAgfQoKICAsIGxlYXZlOiBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgc2VsZiA9ICQoZS5jdXJyZW50VGFyZ2V0KVt0aGlzLnR5cGVdKHRoaXMuX29wdGlvbnMpLmRhdGEodGhpcy50eXBlKQoKICAgICAgaWYgKHRoaXMudGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dCkKICAgICAgaWYgKCFzZWxmLm9wdGlvbnMuZGVsYXkgfHwgIXNlbGYub3B0aW9ucy5kZWxheS5oaWRlKSByZXR1cm4gc2VsZi5oaWRlKCkKCiAgICAgIHNlbGYuaG92ZXJTdGF0ZSA9ICdvdXQnCiAgICAgIHRoaXMudGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHNlbGYuaG92ZXJTdGF0ZSA9PSAnb3V0Jykgc2VsZi5oaWRlKCkKICAgICAgfSwgc2VsZi5vcHRpb25zLmRlbGF5LmhpZGUpCiAgICB9CgogICwgc2hvdzogZnVuY3Rpb24gKCkgewogICAgICB2YXIgJHRpcAogICAgICAgICwgcG9zCiAgICAgICAgLCBhY3R1YWxXaWR0aAogICAgICAgICwgYWN0dWFsSGVpZ2h0CiAgICAgICAgLCBwbGFjZW1lbnQKICAgICAgICAsIHRwCiAgICAgICAgLCBlID0gJC5FdmVudCgnc2hvdycpCgogICAgICBpZiAodGhpcy5oYXNDb250ZW50KCkgJiYgdGhpcy5lbmFibGVkKSB7CiAgICAgICAgdGhpcy4kZWxlbWVudC50cmlnZ2VyKGUpCiAgICAgICAgaWYgKGUuaXNEZWZhdWx0UHJldmVudGVkKCkpIHJldHVybgogICAgICAgICR0aXAgPSB0aGlzLnRpcCgpCiAgICAgICAgdGhpcy5zZXRDb250ZW50KCkKCiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hbmltYXRpb24pIHsKICAgICAgICAgICR0aXAuYWRkQ2xhc3MoJ2ZhZGUnKQogICAgICAgIH0KCiAgICAgICAgcGxhY2VtZW50ID0gdHlwZW9mIHRoaXMub3B0aW9ucy5wbGFjZW1lbnQgPT0gJ2Z1bmN0aW9uJyA/CiAgICAgICAgICB0aGlzLm9wdGlvbnMucGxhY2VtZW50LmNhbGwodGhpcywgJHRpcFswXSwgdGhpcy4kZWxlbWVudFswXSkgOgogICAgICAgICAgdGhpcy5vcHRpb25zLnBsYWNlbWVudAoKICAgICAgICAkdGlwCiAgICAgICAgICAuZGV0YWNoKCkKICAgICAgICAgIC5jc3MoeyB0b3A6IDAsIGxlZnQ6IDAsIGRpc3BsYXk6ICdibG9jaycgfSkKCiAgICAgICAgdGhpcy5vcHRpb25zLmNvbnRhaW5lciA/ICR0aXAuYXBwZW5kVG8odGhpcy5vcHRpb25zLmNvbnRhaW5lcikgOiAkdGlwLmluc2VydEFmdGVyKHRoaXMuJGVsZW1lbnQpCgogICAgICAgIHBvcyA9IHRoaXMuZ2V0UG9zaXRpb24oKQoKICAgICAgICBhY3R1YWxXaWR0aCA9ICR0aXBbMF0ub2Zmc2V0V2lkdGgKICAgICAgICBhY3R1YWxIZWlnaHQgPSAkdGlwWzBdLm9mZnNldEhlaWdodAoKICAgICAgICBzd2l0Y2ggKHBsYWNlbWVudCkgewogICAgICAgICAgY2FzZSAnYm90dG9tJzoKICAgICAgICAgICAgdHAgPSB7dG9wOiBwb3MudG9wICsgcG9zLmhlaWdodCwgbGVmdDogcG9zLmxlZnQgKyBwb3Mud2lkdGggLyAyIC0gYWN0dWFsV2lkdGggLyAyfQogICAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAndG9wJzoKICAgICAgICAgICAgdHAgPSB7dG9wOiBwb3MudG9wIC0gYWN0dWFsSGVpZ2h0LCBsZWZ0OiBwb3MubGVmdCArIHBvcy53aWR0aCAvIDIgLSBhY3R1YWxXaWR0aCAvIDJ9CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlICdsZWZ0JzoKICAgICAgICAgICAgdHAgPSB7dG9wOiBwb3MudG9wICsgcG9zLmhlaWdodCAvIDIgLSBhY3R1YWxIZWlnaHQgLyAyLCBsZWZ0OiBwb3MubGVmdCAtIGFjdHVhbFdpZHRofQogICAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgICB0cCA9IHt0b3A6IHBvcy50b3AgKyBwb3MuaGVpZ2h0IC8gMiAtIGFjdHVhbEhlaWdodCAvIDIsIGxlZnQ6IHBvcy5sZWZ0ICsgcG9zLndpZHRofQogICAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgdGhpcy5hcHBseVBsYWNlbWVudCh0cCwgcGxhY2VtZW50KQogICAgICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcignc2hvd24nKQogICAgICB9CiAgICB9CgogICwgYXBwbHlQbGFjZW1lbnQ6IGZ1bmN0aW9uKG9mZnNldCwgcGxhY2VtZW50KXsKICAgICAgdmFyICR0aXAgPSB0aGlzLnRpcCgpCiAgICAgICAgLCB3aWR0aCA9ICR0aXBbMF0ub2Zmc2V0V2lkdGgKICAgICAgICAsIGhlaWdodCA9ICR0aXBbMF0ub2Zmc2V0SGVpZ2h0CiAgICAgICAgLCBhY3R1YWxXaWR0aAogICAgICAgICwgYWN0dWFsSGVpZ2h0CiAgICAgICAgLCBkZWx0YQogICAgICAgICwgcmVwbGFjZQoKICAgICAgJHRpcAogICAgICAgIC5vZmZzZXQob2Zmc2V0KQogICAgICAgIC5hZGRDbGFzcyhwbGFjZW1lbnQpCiAgICAgICAgLmFkZENsYXNzKCdpbicpCgogICAgICBhY3R1YWxXaWR0aCA9ICR0aXBbMF0ub2Zmc2V0V2lkdGgKICAgICAgYWN0dWFsSGVpZ2h0ID0gJHRpcFswXS5vZmZzZXRIZWlnaHQKCiAgICAgIGlmIChwbGFjZW1lbnQgPT0gJ3RvcCcgJiYgYWN0dWFsSGVpZ2h0ICE9IGhlaWdodCkgewogICAgICAgIG9mZnNldC50b3AgPSBvZmZzZXQudG9wICsgaGVpZ2h0IC0gYWN0dWFsSGVpZ2h0CiAgICAgICAgcmVwbGFjZSA9IHRydWUKICAgICAgfQoKICAgICAgaWYgKHBsYWNlbWVudCA9PSAnYm90dG9tJyB8fCBwbGFjZW1lbnQgPT0gJ3RvcCcpIHsKICAgICAgICBkZWx0YSA9IDAKCiAgICAgICAgaWYgKG9mZnNldC5sZWZ0IDwgMCl7CiAgICAgICAgICBkZWx0YSA9IG9mZnNldC5sZWZ0ICogLTIKICAgICAgICAgIG9mZnNldC5sZWZ0ID0gMAogICAgICAgICAgJHRpcC5vZmZzZXQob2Zmc2V0KQogICAgICAgICAgYWN0dWFsV2lkdGggPSAkdGlwWzBdLm9mZnNldFdpZHRoCiAgICAgICAgICBhY3R1YWxIZWlnaHQgPSAkdGlwWzBdLm9mZnNldEhlaWdodAogICAgICAgIH0KCiAgICAgICAgdGhpcy5yZXBsYWNlQXJyb3coZGVsdGEgLSB3aWR0aCArIGFjdHVhbFdpZHRoLCBhY3R1YWxXaWR0aCwgJ2xlZnQnKQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucmVwbGFjZUFycm93KGFjdHVhbEhlaWdodCAtIGhlaWdodCwgYWN0dWFsSGVpZ2h0LCAndG9wJykKICAgICAgfQoKICAgICAgaWYgKHJlcGxhY2UpICR0aXAub2Zmc2V0KG9mZnNldCkKICAgIH0KCiAgLCByZXBsYWNlQXJyb3c6IGZ1bmN0aW9uKGRlbHRhLCBkaW1lbnNpb24sIHBvc2l0aW9uKXsKICAgICAgdGhpcwogICAgICAgIC5hcnJvdygpCiAgICAgICAgLmNzcyhwb3NpdGlvbiwgZGVsdGEgPyAoNTAgKiAoMSAtIGRlbHRhIC8gZGltZW5zaW9uKSArICIlIikgOiAnJykKICAgIH0KCiAgLCBzZXRDb250ZW50OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciAkdGlwID0gdGhpcy50aXAoKQogICAgICAgICwgdGl0bGUgPSB0aGlzLmdldFRpdGxlKCkKCiAgICAgICR0aXAuZmluZCgnLnRvb2x0aXAtaW5uZXInKVt0aGlzLm9wdGlvbnMuaHRtbCA/ICdodG1sJyA6ICd0ZXh0J10odGl0bGUpCiAgICAgICR0aXAucmVtb3ZlQ2xhc3MoJ2ZhZGUgaW4gdG9wIGJvdHRvbSBsZWZ0IHJpZ2h0JykKICAgIH0KCiAgLCBoaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpcwogICAgICAgICwgJHRpcCA9IHRoaXMudGlwKCkKICAgICAgICAsIGUgPSAkLkV2ZW50KCdoaWRlJykKCiAgICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcihlKQogICAgICBpZiAoZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgcmV0dXJuCgogICAgICAkdGlwLnJlbW92ZUNsYXNzKCdpbicpCgogICAgICBmdW5jdGlvbiByZW1vdmVXaXRoQW5pbWF0aW9uKCkgewogICAgICAgIHZhciB0aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAkdGlwLm9mZigkLnN1cHBvcnQudHJhbnNpdGlvbi5lbmQpLmRldGFjaCgpCiAgICAgICAgfSwgNTAwKQoKICAgICAgICAkdGlwLm9uZSgkLnN1cHBvcnQudHJhbnNpdGlvbi5lbmQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICAgICAgJHRpcC5kZXRhY2goKQogICAgICAgIH0pCiAgICAgIH0KCiAgICAgICQuc3VwcG9ydC50cmFuc2l0aW9uICYmIHRoaXMuJHRpcC5oYXNDbGFzcygnZmFkZScpID8KICAgICAgICByZW1vdmVXaXRoQW5pbWF0aW9uKCkgOgogICAgICAgICR0aXAuZGV0YWNoKCkKCiAgICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcignaGlkZGVuJykKCiAgICAgIHJldHVybiB0aGlzCiAgICB9CgogICwgZml4VGl0bGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyICRlID0gdGhpcy4kZWxlbWVudAogICAgICBpZiAoJGUuYXR0cigndGl0bGUnKSB8fCB0eXBlb2YoJGUuYXR0cignZGF0YS1vcmlnaW5hbC10aXRsZScpKSAhPSAnc3RyaW5nJykgewogICAgICAgICRlLmF0dHIoJ2RhdGEtb3JpZ2luYWwtdGl0bGUnLCAkZS5hdHRyKCd0aXRsZScpIHx8ICcnKS5hdHRyKCd0aXRsZScsICcnKQogICAgICB9CiAgICB9CgogICwgaGFzQ29udGVudDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRUaXRsZSgpCiAgICB9CgogICwgZ2V0UG9zaXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGVsID0gdGhpcy4kZWxlbWVudFswXQogICAgICByZXR1cm4gJC5leHRlbmQoe30sICh0eXBlb2YgZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ID09ICdmdW5jdGlvbicpID8gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkgOiB7CiAgICAgICAgd2lkdGg6IGVsLm9mZnNldFdpZHRoCiAgICAgICwgaGVpZ2h0OiBlbC5vZmZzZXRIZWlnaHQKICAgICAgfSwgdGhpcy4kZWxlbWVudC5vZmZzZXQoKSkKICAgIH0KCiAgLCBnZXRUaXRsZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGl0bGUKICAgICAgICAsICRlID0gdGhpcy4kZWxlbWVudAogICAgICAgICwgbyA9IHRoaXMub3B0aW9ucwoKICAgICAgdGl0bGUgPSAkZS5hdHRyKCdkYXRhLW9yaWdpbmFsLXRpdGxlJykKICAgICAgICB8fCAodHlwZW9mIG8udGl0bGUgPT0gJ2Z1bmN0aW9uJyA/IG8udGl0bGUuY2FsbCgkZVswXSkgOiAgby50aXRsZSkKCiAgICAgIHJldHVybiB0aXRsZQogICAgfQoKICAsIHRpcDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy4kdGlwID0gdGhpcy4kdGlwIHx8ICQodGhpcy5vcHRpb25zLnRlbXBsYXRlKQogICAgfQoKICAsIGFycm93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy4kYXJyb3cgPSB0aGlzLiRhcnJvdyB8fCB0aGlzLnRpcCgpLmZpbmQoIi50b29sdGlwLWFycm93IikKICAgIH0KCiAgLCB2YWxpZGF0ZTogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMuJGVsZW1lbnRbMF0ucGFyZW50Tm9kZSkgewogICAgICAgIHRoaXMuaGlkZSgpCiAgICAgICAgdGhpcy4kZWxlbWVudCA9IG51bGwKICAgICAgICB0aGlzLm9wdGlvbnMgPSBudWxsCiAgICAgIH0KICAgIH0KCiAgLCBlbmFibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZQogICAgfQoKICAsIGRpc2FibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2UKICAgIH0KCiAgLCB0b2dnbGVFbmFibGVkOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZW5hYmxlZCA9ICF0aGlzLmVuYWJsZWQKICAgIH0KCiAgLCB0b2dnbGU6IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBzZWxmID0gZSA/ICQoZS5jdXJyZW50VGFyZ2V0KVt0aGlzLnR5cGVdKHRoaXMuX29wdGlvbnMpLmRhdGEodGhpcy50eXBlKSA6IHRoaXMKICAgICAgc2VsZi50aXAoKS5oYXNDbGFzcygnaW4nKSA/IHNlbGYuaGlkZSgpIDogc2VsZi5zaG93KCkKICAgIH0KCiAgLCBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuaGlkZSgpLiRlbGVtZW50Lm9mZignLicgKyB0aGlzLnR5cGUpLnJlbW92ZURhdGEodGhpcy50eXBlKQogICAgfQoKICB9CgoKIC8qIFRPT0xUSVAgUExVR0lOIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIG9sZCA9ICQuZm4udG9vbHRpcAoKICAkLmZuLnRvb2x0aXAgPSBmdW5jdGlvbiAoIG9wdGlvbiApIHsKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpCiAgICAgICAgLCBkYXRhID0gJHRoaXMuZGF0YSgndG9vbHRpcCcpCiAgICAgICAgLCBvcHRpb25zID0gdHlwZW9mIG9wdGlvbiA9PSAnb2JqZWN0JyAmJiBvcHRpb24KICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCd0b29sdGlwJywgKGRhdGEgPSBuZXcgVG9vbHRpcCh0aGlzLCBvcHRpb25zKSkpCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9uID09ICdzdHJpbmcnKSBkYXRhW29wdGlvbl0oKQogICAgfSkKICB9CgogICQuZm4udG9vbHRpcC5Db25zdHJ1Y3RvciA9IFRvb2x0aXAKCiAgJC5mbi50b29sdGlwLmRlZmF1bHRzID0gewogICAgYW5pbWF0aW9uOiB0cnVlCiAgLCBwbGFjZW1lbnQ6ICd0b3AnCiAgLCBzZWxlY3RvcjogZmFsc2UKICAsIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0idG9vbHRpcCI+PGRpdiBjbGFzcz0idG9vbHRpcC1hcnJvdyI+PC9kaXY+PGRpdiBjbGFzcz0idG9vbHRpcC1pbm5lciI+PC9kaXY+PC9kaXY+JwogICwgdHJpZ2dlcjogJ2hvdmVyIGZvY3VzJwogICwgdGl0bGU6ICcnCiAgLCBkZWxheTogMAogICwgaHRtbDogZmFsc2UKICAsIGNvbnRhaW5lcjogZmFsc2UKICB9CgoKIC8qIFRPT0xUSVAgTk8gQ09ORkxJQ1QKICAqID09PT09PT09PT09PT09PT09PT0gKi8KCiAgJC5mbi50b29sdGlwLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICAkLmZuLnRvb2x0aXAgPSBvbGQKICAgIHJldHVybiB0aGlzCiAgfQoKfSh3aW5kb3cualF1ZXJ5KTsKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogYm9vdHN0cmFwLXBvcG92ZXIuanMgdjIuMy4xCiAqIGh0dHA6Ly90d2l0dGVyLmdpdGh1Yi5jb20vYm9vdHN0cmFwL2phdmFzY3JpcHQuaHRtbCNwb3BvdmVycwogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDb3B5cmlnaHQgMjAxMiBUd2l0dGVyLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCgohZnVuY3Rpb24gKCQpIHsKCiAgInVzZSBzdHJpY3QiOyAvLyBqc2hpbnQgO187CgoKIC8qIFBPUE9WRVIgUFVCTElDIENMQVNTIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIFBvcG92ZXIgPSBmdW5jdGlvbiAoZWxlbWVudCwgb3B0aW9ucykgewogICAgdGhpcy5pbml0KCdwb3BvdmVyJywgZWxlbWVudCwgb3B0aW9ucykKICB9CgoKICAvKiBOT1RFOiBQT1BPVkVSIEVYVEVORFMgQk9PVFNUUkFQLVRPT0xUSVAuanMKICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgUG9wb3Zlci5wcm90b3R5cGUgPSAkLmV4dGVuZCh7fSwgJC5mbi50b29sdGlwLkNvbnN0cnVjdG9yLnByb3RvdHlwZSwgewoKICAgIGNvbnN0cnVjdG9yOiBQb3BvdmVyCgogICwgc2V0Q29udGVudDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgJHRpcCA9IHRoaXMudGlwKCkKICAgICAgICAsIHRpdGxlID0gdGhpcy5nZXRUaXRsZSgpCiAgICAgICAgLCBjb250ZW50ID0gdGhpcy5nZXRDb250ZW50KCkKCiAgICAgICR0aXAuZmluZCgnLnBvcG92ZXItdGl0bGUnKVt0aGlzLm9wdGlvbnMuaHRtbCA/ICdodG1sJyA6ICd0ZXh0J10odGl0bGUpCiAgICAgICR0aXAuZmluZCgnLnBvcG92ZXItY29udGVudCcpW3RoaXMub3B0aW9ucy5odG1sID8gJ2h0bWwnIDogJ3RleHQnXShjb250ZW50KQoKICAgICAgJHRpcC5yZW1vdmVDbGFzcygnZmFkZSB0b3AgYm90dG9tIGxlZnQgcmlnaHQgaW4nKQogICAgfQoKICAsIGhhc0NvbnRlbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0VGl0bGUoKSB8fCB0aGlzLmdldENvbnRlbnQoKQogICAgfQoKICAsIGdldENvbnRlbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNvbnRlbnQKICAgICAgICAsICRlID0gdGhpcy4kZWxlbWVudAogICAgICAgICwgbyA9IHRoaXMub3B0aW9ucwoKICAgICAgY29udGVudCA9ICh0eXBlb2Ygby5jb250ZW50ID09ICdmdW5jdGlvbicgPyBvLmNvbnRlbnQuY2FsbCgkZVswXSkgOiAgby5jb250ZW50KQogICAgICAgIHx8ICRlLmF0dHIoJ2RhdGEtY29udGVudCcpCgogICAgICByZXR1cm4gY29udGVudAogICAgfQoKICAsIHRpcDogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMuJHRpcCkgewogICAgICAgIHRoaXMuJHRpcCA9ICQodGhpcy5vcHRpb25zLnRlbXBsYXRlKQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLiR0aXAKICAgIH0KCiAgLCBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuaGlkZSgpLiRlbGVtZW50Lm9mZignLicgKyB0aGlzLnR5cGUpLnJlbW92ZURhdGEodGhpcy50eXBlKQogICAgfQoKICB9KQoKCiAvKiBQT1BPVkVSIFBMVUdJTiBERUZJTklUSU9OCiAgKiA9PT09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgb2xkID0gJC5mbi5wb3BvdmVyCgogICQuZm4ucG9wb3ZlciA9IGZ1bmN0aW9uIChvcHRpb24pIHsKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpCiAgICAgICAgLCBkYXRhID0gJHRoaXMuZGF0YSgncG9wb3ZlcicpCiAgICAgICAgLCBvcHRpb25zID0gdHlwZW9mIG9wdGlvbiA9PSAnb2JqZWN0JyAmJiBvcHRpb24KICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCdwb3BvdmVyJywgKGRhdGEgPSBuZXcgUG9wb3Zlcih0aGlzLCBvcHRpb25zKSkpCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9uID09ICdzdHJpbmcnKSBkYXRhW29wdGlvbl0oKQogICAgfSkKICB9CgogICQuZm4ucG9wb3Zlci5Db25zdHJ1Y3RvciA9IFBvcG92ZXIKCiAgJC5mbi5wb3BvdmVyLmRlZmF1bHRzID0gJC5leHRlbmQoe30gLCAkLmZuLnRvb2x0aXAuZGVmYXVsdHMsIHsKICAgIHBsYWNlbWVudDogJ3JpZ2h0JwogICwgdHJpZ2dlcjogJ2NsaWNrJwogICwgY29udGVudDogJycKICAsIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0icG9wb3ZlciI+PGRpdiBjbGFzcz0iYXJyb3ciPjwvZGl2PjxoMyBjbGFzcz0icG9wb3Zlci10aXRsZSI+PC9oMz48ZGl2IGNsYXNzPSJwb3BvdmVyLWNvbnRlbnQiPjwvZGl2PjwvZGl2PicKICB9KQoKCiAvKiBQT1BPVkVSIE5PIENPTkZMSUNUCiAgKiA9PT09PT09PT09PT09PT09PT09ICovCgogICQuZm4ucG9wb3Zlci5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgJC5mbi5wb3BvdmVyID0gb2xkCiAgICByZXR1cm4gdGhpcwogIH0KCn0od2luZG93LmpRdWVyeSk7Ci8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogYm9vdHN0cmFwLXNjcm9sbHNweS5qcyB2Mi4zLjEKICogaHR0cDovL3R3aXR0ZXIuZ2l0aHViLmNvbS9ib290c3RyYXAvamF2YXNjcmlwdC5odG1sI3Njcm9sbHNweQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIENvcHlyaWdodCAyMDEyIFR3aXR0ZXIsIEluYy4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKCiFmdW5jdGlvbiAoJCkgewoKICAidXNlIHN0cmljdCI7IC8vIGpzaGludCA7XzsKCgogLyogU0NST0xMU1BZIENMQVNTIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgogIGZ1bmN0aW9uIFNjcm9sbFNweShlbGVtZW50LCBvcHRpb25zKSB7CiAgICB2YXIgcHJvY2VzcyA9ICQucHJveHkodGhpcy5wcm9jZXNzLCB0aGlzKQogICAgICAsICRlbGVtZW50ID0gJChlbGVtZW50KS5pcygnYm9keScpID8gJCh3aW5kb3cpIDogJChlbGVtZW50KQogICAgICAsIGhyZWYKICAgIHRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCAkLmZuLnNjcm9sbHNweS5kZWZhdWx0cywgb3B0aW9ucykKICAgIHRoaXMuJHNjcm9sbEVsZW1lbnQgPSAkZWxlbWVudC5vbignc2Nyb2xsLnNjcm9sbC1zcHkuZGF0YS1hcGknLCBwcm9jZXNzKQogICAgdGhpcy5zZWxlY3RvciA9ICh0aGlzLm9wdGlvbnMudGFyZ2V0CiAgICAgIHx8ICgoaHJlZiA9ICQoZWxlbWVudCkuYXR0cignaHJlZicpKSAmJiBocmVmLnJlcGxhY2UoLy4qKD89I1teXHNdKyQpLywgJycpKSAvL3N0cmlwIGZvciBpZTcKICAgICAgfHwgJycpICsgJyAubmF2IGxpID4gYScKICAgIHRoaXMuJGJvZHkgPSAkKCdib2R5JykKICAgIHRoaXMucmVmcmVzaCgpCiAgICB0aGlzLnByb2Nlc3MoKQogIH0KCiAgU2Nyb2xsU3B5LnByb3RvdHlwZSA9IHsKCiAgICAgIGNvbnN0cnVjdG9yOiBTY3JvbGxTcHkKCiAgICAsIHJlZnJlc2g6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXMKICAgICAgICAgICwgJHRhcmdldHMKCiAgICAgICAgdGhpcy5vZmZzZXRzID0gJChbXSkKICAgICAgICB0aGlzLnRhcmdldHMgPSAkKFtdKQoKICAgICAgICAkdGFyZ2V0cyA9IHRoaXMuJGJvZHkKICAgICAgICAgIC5maW5kKHRoaXMuc2VsZWN0b3IpCiAgICAgICAgICAubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyICRlbCA9ICQodGhpcykKICAgICAgICAgICAgICAsIGhyZWYgPSAkZWwuZGF0YSgndGFyZ2V0JykgfHwgJGVsLmF0dHIoJ2hyZWYnKQogICAgICAgICAgICAgICwgJGhyZWYgPSAvXiNcdy8udGVzdChocmVmKSAmJiAkKGhyZWYpCiAgICAgICAgICAgIHJldHVybiAoICRocmVmCiAgICAgICAgICAgICAgJiYgJGhyZWYubGVuZ3RoCiAgICAgICAgICAgICAgJiYgW1sgJGhyZWYucG9zaXRpb24oKS50b3AgKyAoISQuaXNXaW5kb3coc2VsZi4kc2Nyb2xsRWxlbWVudC5nZXQoMCkpICYmIHNlbGYuJHNjcm9sbEVsZW1lbnQuc2Nyb2xsVG9wKCkpLCBocmVmIF1dICkgfHwgbnVsbAogICAgICAgICAgfSkKICAgICAgICAgIC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhWzBdIC0gYlswXSB9KQogICAgICAgICAgLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLm9mZnNldHMucHVzaCh0aGlzWzBdKQogICAgICAgICAgICBzZWxmLnRhcmdldHMucHVzaCh0aGlzWzFdKQogICAgICAgICAgfSkKICAgICAgfQoKICAgICwgcHJvY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzY3JvbGxUb3AgPSB0aGlzLiRzY3JvbGxFbGVtZW50LnNjcm9sbFRvcCgpICsgdGhpcy5vcHRpb25zLm9mZnNldAogICAgICAgICAgLCBzY3JvbGxIZWlnaHQgPSB0aGlzLiRzY3JvbGxFbGVtZW50WzBdLnNjcm9sbEhlaWdodCB8fCB0aGlzLiRib2R5WzBdLnNjcm9sbEhlaWdodAogICAgICAgICAgLCBtYXhTY3JvbGwgPSBzY3JvbGxIZWlnaHQgLSB0aGlzLiRzY3JvbGxFbGVtZW50LmhlaWdodCgpCiAgICAgICAgICAsIG9mZnNldHMgPSB0aGlzLm9mZnNldHMKICAgICAgICAgICwgdGFyZ2V0cyA9IHRoaXMudGFyZ2V0cwogICAgICAgICAgLCBhY3RpdmVUYXJnZXQgPSB0aGlzLmFjdGl2ZVRhcmdldAogICAgICAgICAgLCBpCgogICAgICAgIGlmIChzY3JvbGxUb3AgPj0gbWF4U2Nyb2xsKSB7CiAgICAgICAgICByZXR1cm4gYWN0aXZlVGFyZ2V0ICE9IChpID0gdGFyZ2V0cy5sYXN0KClbMF0pCiAgICAgICAgICAgICYmIHRoaXMuYWN0aXZhdGUgKCBpICkKICAgICAgICB9CgogICAgICAgIGZvciAoaSA9IG9mZnNldHMubGVuZ3RoOyBpLS07KSB7CiAgICAgICAgICBhY3RpdmVUYXJnZXQgIT0gdGFyZ2V0c1tpXQogICAgICAgICAgICAmJiBzY3JvbGxUb3AgPj0gb2Zmc2V0c1tpXQogICAgICAgICAgICAmJiAoIW9mZnNldHNbaSArIDFdIHx8IHNjcm9sbFRvcCA8PSBvZmZzZXRzW2kgKyAxXSkKICAgICAgICAgICAgJiYgdGhpcy5hY3RpdmF0ZSggdGFyZ2V0c1tpXSApCiAgICAgICAgfQogICAgICB9CgogICAgLCBhY3RpdmF0ZTogZnVuY3Rpb24gKHRhcmdldCkgewogICAgICAgIHZhciBhY3RpdmUKICAgICAgICAgICwgc2VsZWN0b3IKCiAgICAgICAgdGhpcy5hY3RpdmVUYXJnZXQgPSB0YXJnZXQKCiAgICAgICAgJCh0aGlzLnNlbGVjdG9yKQogICAgICAgICAgLnBhcmVudCgnLmFjdGl2ZScpCiAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpCgogICAgICAgIHNlbGVjdG9yID0gdGhpcy5zZWxlY3RvcgogICAgICAgICAgKyAnW2RhdGEtdGFyZ2V0PSInICsgdGFyZ2V0ICsgJyJdLCcKICAgICAgICAgICsgdGhpcy5zZWxlY3RvciArICdbaHJlZj0iJyArIHRhcmdldCArICciXScKCiAgICAgICAgYWN0aXZlID0gJChzZWxlY3RvcikKICAgICAgICAgIC5wYXJlbnQoJ2xpJykKICAgICAgICAgIC5hZGRDbGFzcygnYWN0aXZlJykKCiAgICAgICAgaWYgKGFjdGl2ZS5wYXJlbnQoJy5kcm9wZG93bi1tZW51JykubGVuZ3RoKSAgewogICAgICAgICAgYWN0aXZlID0gYWN0aXZlLmNsb3Nlc3QoJ2xpLmRyb3Bkb3duJykuYWRkQ2xhc3MoJ2FjdGl2ZScpCiAgICAgICAgfQoKICAgICAgICBhY3RpdmUudHJpZ2dlcignYWN0aXZhdGUnKQogICAgICB9CgogIH0KCgogLyogU0NST0xMU1BZIFBMVUdJTiBERUZJTklUSU9OCiAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIG9sZCA9ICQuZm4uc2Nyb2xsc3B5CgogICQuZm4uc2Nyb2xsc3B5ID0gZnVuY3Rpb24gKG9wdGlvbikgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciAkdGhpcyA9ICQodGhpcykKICAgICAgICAsIGRhdGEgPSAkdGhpcy5kYXRhKCdzY3JvbGxzcHknKQogICAgICAgICwgb3B0aW9ucyA9IHR5cGVvZiBvcHRpb24gPT0gJ29iamVjdCcgJiYgb3B0aW9uCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnc2Nyb2xsc3B5JywgKGRhdGEgPSBuZXcgU2Nyb2xsU3B5KHRoaXMsIG9wdGlvbnMpKSkKICAgICAgaWYgKHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycpIGRhdGFbb3B0aW9uXSgpCiAgICB9KQogIH0KCiAgJC5mbi5zY3JvbGxzcHkuQ29uc3RydWN0b3IgPSBTY3JvbGxTcHkKCiAgJC5mbi5zY3JvbGxzcHkuZGVmYXVsdHMgPSB7CiAgICBvZmZzZXQ6IDEwCiAgfQoKCiAvKiBTQ1JPTExTUFkgTk8gQ09ORkxJQ1QKICAqID09PT09PT09PT09PT09PT09PT09PSAqLwoKICAkLmZuLnNjcm9sbHNweS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgJC5mbi5zY3JvbGxzcHkgPSBvbGQKICAgIHJldHVybiB0aGlzCiAgfQoKCiAvKiBTQ1JPTExTUFkgREFUQS1BUEkKICAqID09PT09PT09PT09PT09PT09PSAqLwoKICAkKHdpbmRvdykub24oJ2xvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAkKCdbZGF0YS1zcHk9InNjcm9sbCJdJykuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciAkc3B5ID0gJCh0aGlzKQogICAgICAkc3B5LnNjcm9sbHNweSgkc3B5LmRhdGEoKSkKICAgIH0pCiAgfSkKCn0od2luZG93LmpRdWVyeSk7LyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogYm9vdHN0cmFwLXRhYi5qcyB2Mi4zLjEKICogaHR0cDovL3R3aXR0ZXIuZ2l0aHViLmNvbS9ib290c3RyYXAvamF2YXNjcmlwdC5odG1sI3RhYnMKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogQ29weXJpZ2h0IDIwMTIgVHdpdHRlciwgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgoKIWZ1bmN0aW9uICgkKSB7CgogICJ1c2Ugc3RyaWN0IjsgLy8ganNoaW50IDtfOwoKCiAvKiBUQUIgQ0xBU1MgREVGSU5JVElPTgogICogPT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIFRhYiA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICB0aGlzLmVsZW1lbnQgPSAkKGVsZW1lbnQpCiAgfQoKICBUYWIucHJvdG90eXBlID0gewoKICAgIGNvbnN0cnVjdG9yOiBUYWIKCiAgLCBzaG93OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciAkdGhpcyA9IHRoaXMuZWxlbWVudAogICAgICAgICwgJHVsID0gJHRoaXMuY2xvc2VzdCgndWw6bm90KC5kcm9wZG93bi1tZW51KScpCiAgICAgICAgLCBzZWxlY3RvciA9ICR0aGlzLmF0dHIoJ2RhdGEtdGFyZ2V0JykKICAgICAgICAsIHByZXZpb3VzCiAgICAgICAgLCAkdGFyZ2V0CiAgICAgICAgLCBlCgogICAgICBpZiAoIXNlbGVjdG9yKSB7CiAgICAgICAgc2VsZWN0b3IgPSAkdGhpcy5hdHRyKCdocmVmJykKICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yICYmIHNlbGVjdG9yLnJlcGxhY2UoLy4qKD89I1teXHNdKiQpLywgJycpIC8vc3RyaXAgZm9yIGllNwogICAgICB9CgogICAgICBpZiAoICR0aGlzLnBhcmVudCgnbGknKS5oYXNDbGFzcygnYWN0aXZlJykgKSByZXR1cm4KCiAgICAgIHByZXZpb3VzID0gJHVsLmZpbmQoJy5hY3RpdmU6bGFzdCBhJylbMF0KCiAgICAgIGUgPSAkLkV2ZW50KCdzaG93JywgewogICAgICAgIHJlbGF0ZWRUYXJnZXQ6IHByZXZpb3VzCiAgICAgIH0pCgogICAgICAkdGhpcy50cmlnZ2VyKGUpCgogICAgICBpZiAoZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgcmV0dXJuCgogICAgICAkdGFyZ2V0ID0gJChzZWxlY3RvcikKCiAgICAgIHRoaXMuYWN0aXZhdGUoJHRoaXMucGFyZW50KCdsaScpLCAkdWwpCiAgICAgIHRoaXMuYWN0aXZhdGUoJHRhcmdldCwgJHRhcmdldC5wYXJlbnQoKSwgZnVuY3Rpb24gKCkgewogICAgICAgICR0aGlzLnRyaWdnZXIoewogICAgICAgICAgdHlwZTogJ3Nob3duJwogICAgICAgICwgcmVsYXRlZFRhcmdldDogcHJldmlvdXMKICAgICAgICB9KQogICAgICB9KQogICAgfQoKICAsIGFjdGl2YXRlOiBmdW5jdGlvbiAoIGVsZW1lbnQsIGNvbnRhaW5lciwgY2FsbGJhY2spIHsKICAgICAgdmFyICRhY3RpdmUgPSBjb250YWluZXIuZmluZCgnPiAuYWN0aXZlJykKICAgICAgICAsIHRyYW5zaXRpb24gPSBjYWxsYmFjawogICAgICAgICAgICAmJiAkLnN1cHBvcnQudHJhbnNpdGlvbgogICAgICAgICAgICAmJiAkYWN0aXZlLmhhc0NsYXNzKCdmYWRlJykKCiAgICAgIGZ1bmN0aW9uIG5leHQoKSB7CiAgICAgICAgJGFjdGl2ZQogICAgICAgICAgLnJlbW92ZUNsYXNzKCdhY3RpdmUnKQogICAgICAgICAgLmZpbmQoJz4gLmRyb3Bkb3duLW1lbnUgPiAuYWN0aXZlJykKICAgICAgICAgIC5yZW1vdmVDbGFzcygnYWN0aXZlJykKCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnYWN0aXZlJykKCiAgICAgICAgaWYgKHRyYW5zaXRpb24pIHsKICAgICAgICAgIGVsZW1lbnRbMF0ub2Zmc2V0V2lkdGggLy8gcmVmbG93IGZvciB0cmFuc2l0aW9uCiAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdpbicpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoJ2ZhZGUnKQogICAgICAgIH0KCiAgICAgICAgaWYgKCBlbGVtZW50LnBhcmVudCgnLmRyb3Bkb3duLW1lbnUnKSApIHsKICAgICAgICAgIGVsZW1lbnQuY2xvc2VzdCgnbGkuZHJvcGRvd24nKS5hZGRDbGFzcygnYWN0aXZlJykKICAgICAgICB9CgogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKCkKICAgICAgfQoKICAgICAgdHJhbnNpdGlvbiA/CiAgICAgICAgJGFjdGl2ZS5vbmUoJC5zdXBwb3J0LnRyYW5zaXRpb24uZW5kLCBuZXh0KSA6CiAgICAgICAgbmV4dCgpCgogICAgICAkYWN0aXZlLnJlbW92ZUNsYXNzKCdpbicpCiAgICB9CiAgfQoKCiAvKiBUQUIgUExVR0lOIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgb2xkID0gJC5mbi50YWIKCiAgJC5mbi50YWIgPSBmdW5jdGlvbiAoIG9wdGlvbiApIHsKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpCiAgICAgICAgLCBkYXRhID0gJHRoaXMuZGF0YSgndGFiJykKICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCd0YWInLCAoZGF0YSA9IG5ldyBUYWIodGhpcykpKQogICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PSAnc3RyaW5nJykgZGF0YVtvcHRpb25dKCkKICAgIH0pCiAgfQoKICAkLmZuLnRhYi5Db25zdHJ1Y3RvciA9IFRhYgoKCiAvKiBUQUIgTk8gQ09ORkxJQ1QKICAqID09PT09PT09PT09PT09PSAqLwoKICAkLmZuLnRhYi5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgJC5mbi50YWIgPSBvbGQKICAgIHJldHVybiB0aGlzCiAgfQoKCiAvKiBUQUIgREFUQS1BUEkKICAqID09PT09PT09PT09PSAqLwoKICAkKGRvY3VtZW50KS5vbignY2xpY2sudGFiLmRhdGEtYXBpJywgJ1tkYXRhLXRvZ2dsZT0idGFiIl0sIFtkYXRhLXRvZ2dsZT0icGlsbCJdJywgZnVuY3Rpb24gKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKQogICAgJCh0aGlzKS50YWIoJ3Nob3cnKQogIH0pCgp9KHdpbmRvdy5qUXVlcnkpOy8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogYm9vdHN0cmFwLXR5cGVhaGVhZC5qcyB2Mi4zLjEKICogaHR0cDovL3R3aXR0ZXIuZ2l0aHViLmNvbS9ib290c3RyYXAvamF2YXNjcmlwdC5odG1sI3R5cGVhaGVhZAogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIENvcHlyaWdodCAyMDEyIFR3aXR0ZXIsIEluYy4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCgohZnVuY3Rpb24oJCl7CgogICJ1c2Ugc3RyaWN0IjsgLy8ganNoaW50IDtfOwoKCiAvKiBUWVBFQUhFQUQgUFVCTElDIENMQVNTIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgVHlwZWFoZWFkID0gZnVuY3Rpb24gKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgIHRoaXMuJGVsZW1lbnQgPSAkKGVsZW1lbnQpCiAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgJC5mbi50eXBlYWhlYWQuZGVmYXVsdHMsIG9wdGlvbnMpCiAgICB0aGlzLm1hdGNoZXIgPSB0aGlzLm9wdGlvbnMubWF0Y2hlciB8fCB0aGlzLm1hdGNoZXIKICAgIHRoaXMuc29ydGVyID0gdGhpcy5vcHRpb25zLnNvcnRlciB8fCB0aGlzLnNvcnRlcgogICAgdGhpcy5oaWdobGlnaHRlciA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHRlciB8fCB0aGlzLmhpZ2hsaWdodGVyCiAgICB0aGlzLnVwZGF0ZXIgPSB0aGlzLm9wdGlvbnMudXBkYXRlciB8fCB0aGlzLnVwZGF0ZXIKICAgIHRoaXMuc291cmNlID0gdGhpcy5vcHRpb25zLnNvdXJjZQogICAgdGhpcy4kbWVudSA9ICQodGhpcy5vcHRpb25zLm1lbnUpCiAgICB0aGlzLnNob3duID0gZmFsc2UKICAgIHRoaXMubGlzdGVuKCkKICB9CgogIFR5cGVhaGVhZC5wcm90b3R5cGUgPSB7CgogICAgY29uc3RydWN0b3I6IFR5cGVhaGVhZAoKICAsIHNlbGVjdDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgdmFsID0gdGhpcy4kbWVudS5maW5kKCcuYWN0aXZlJykuYXR0cignZGF0YS12YWx1ZScpCiAgICAgIHRoaXMuJGVsZW1lbnQKICAgICAgICAudmFsKHRoaXMudXBkYXRlcih2YWwpKQogICAgICAgIC5jaGFuZ2UoKQogICAgICByZXR1cm4gdGhpcy5oaWRlKCkKICAgIH0KCiAgLCB1cGRhdGVyOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gaXRlbQogICAgfQoKICAsIHNob3c6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHBvcyA9ICQuZXh0ZW5kKHt9LCB0aGlzLiRlbGVtZW50LnBvc2l0aW9uKCksIHsKICAgICAgICBoZWlnaHQ6IHRoaXMuJGVsZW1lbnRbMF0ub2Zmc2V0SGVpZ2h0CiAgICAgIH0pCgogICAgICB0aGlzLiRtZW51CiAgICAgICAgLmluc2VydEFmdGVyKHRoaXMuJGVsZW1lbnQpCiAgICAgICAgLmNzcyh7CiAgICAgICAgICB0b3A6IHBvcy50b3AgKyBwb3MuaGVpZ2h0CiAgICAgICAgLCBsZWZ0OiBwb3MubGVmdAogICAgICAgIH0pCiAgICAgICAgLnNob3coKQoKICAgICAgdGhpcy5zaG93biA9IHRydWUKICAgICAgcmV0dXJuIHRoaXMKICAgIH0KCiAgLCBoaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuJG1lbnUuaGlkZSgpCiAgICAgIHRoaXMuc2hvd24gPSBmYWxzZQogICAgICByZXR1cm4gdGhpcwogICAgfQoKICAsIGxvb2t1cDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBpdGVtcwoKICAgICAgdGhpcy5xdWVyeSA9IHRoaXMuJGVsZW1lbnQudmFsKCkKCiAgICAgIGlmICghdGhpcy5xdWVyeSB8fCB0aGlzLnF1ZXJ5Lmxlbmd0aCA8IHRoaXMub3B0aW9ucy5taW5MZW5ndGgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zaG93biA/IHRoaXMuaGlkZSgpIDogdGhpcwogICAgICB9CgogICAgICBpdGVtcyA9ICQuaXNGdW5jdGlvbih0aGlzLnNvdXJjZSkgPyB0aGlzLnNvdXJjZSh0aGlzLnF1ZXJ5LCAkLnByb3h5KHRoaXMucHJvY2VzcywgdGhpcykpIDogdGhpcy5zb3VyY2UKCiAgICAgIHJldHVybiBpdGVtcyA/IHRoaXMucHJvY2VzcyhpdGVtcykgOiB0aGlzCiAgICB9CgogICwgcHJvY2VzczogZnVuY3Rpb24gKGl0ZW1zKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpcwoKICAgICAgaXRlbXMgPSAkLmdyZXAoaXRlbXMsIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoYXQubWF0Y2hlcihpdGVtKQogICAgICB9KQoKICAgICAgaXRlbXMgPSB0aGlzLnNvcnRlcihpdGVtcykKCiAgICAgIGlmICghaXRlbXMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2hvd24gPyB0aGlzLmhpZGUoKSA6IHRoaXMKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMucmVuZGVyKGl0ZW1zLnNsaWNlKDAsIHRoaXMub3B0aW9ucy5pdGVtcykpLnNob3coKQogICAgfQoKICAsIG1hdGNoZXI6IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiB+aXRlbS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGhpcy5xdWVyeS50b0xvd2VyQ2FzZSgpKQogICAgfQoKICAsIHNvcnRlcjogZnVuY3Rpb24gKGl0ZW1zKSB7CiAgICAgIHZhciBiZWdpbnN3aXRoID0gW10KICAgICAgICAsIGNhc2VTZW5zaXRpdmUgPSBbXQogICAgICAgICwgY2FzZUluc2Vuc2l0aXZlID0gW10KICAgICAgICAsIGl0ZW0KCiAgICAgIHdoaWxlIChpdGVtID0gaXRlbXMuc2hpZnQoKSkgewogICAgICAgIGlmICghaXRlbS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGhpcy5xdWVyeS50b0xvd2VyQ2FzZSgpKSkgYmVnaW5zd2l0aC5wdXNoKGl0ZW0pCiAgICAgICAgZWxzZSBpZiAofml0ZW0uaW5kZXhPZih0aGlzLnF1ZXJ5KSkgY2FzZVNlbnNpdGl2ZS5wdXNoKGl0ZW0pCiAgICAgICAgZWxzZSBjYXNlSW5zZW5zaXRpdmUucHVzaChpdGVtKQogICAgICB9CgogICAgICByZXR1cm4gYmVnaW5zd2l0aC5jb25jYXQoY2FzZVNlbnNpdGl2ZSwgY2FzZUluc2Vuc2l0aXZlKQogICAgfQoKICAsIGhpZ2hsaWdodGVyOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICB2YXIgcXVlcnkgPSB0aGlzLnF1ZXJ5LnJlcGxhY2UoL1tcLVxbXF17fSgpKis/LixcXFxeJHwjXHNdL2csICdcXCQmJykKICAgICAgcmV0dXJuIGl0ZW0ucmVwbGFjZShuZXcgUmVnRXhwKCcoJyArIHF1ZXJ5ICsgJyknLCAnaWcnKSwgZnVuY3Rpb24gKCQxLCBtYXRjaCkgewogICAgICAgIHJldHVybiAnPHN0cm9uZz4nICsgbWF0Y2ggKyAnPC9zdHJvbmc+JwogICAgICB9KQogICAgfQoKICAsIHJlbmRlcjogZnVuY3Rpb24gKGl0ZW1zKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpcwoKICAgICAgaXRlbXMgPSAkKGl0ZW1zKS5tYXAoZnVuY3Rpb24gKGksIGl0ZW0pIHsKICAgICAgICBpID0gJCh0aGF0Lm9wdGlvbnMuaXRlbSkuYXR0cignZGF0YS12YWx1ZScsIGl0ZW0pCiAgICAgICAgaS5maW5kKCdhJykuaHRtbCh0aGF0LmhpZ2hsaWdodGVyKGl0ZW0pKQogICAgICAgIHJldHVybiBpWzBdCiAgICAgIH0pCgogICAgICBpdGVtcy5maXJzdCgpLmFkZENsYXNzKCdhY3RpdmUnKQogICAgICB0aGlzLiRtZW51Lmh0bWwoaXRlbXMpCiAgICAgIHJldHVybiB0aGlzCiAgICB9CgogICwgbmV4dDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBhY3RpdmUgPSB0aGlzLiRtZW51LmZpbmQoJy5hY3RpdmUnKS5yZW1vdmVDbGFzcygnYWN0aXZlJykKICAgICAgICAsIG5leHQgPSBhY3RpdmUubmV4dCgpCgogICAgICBpZiAoIW5leHQubGVuZ3RoKSB7CiAgICAgICAgbmV4dCA9ICQodGhpcy4kbWVudS5maW5kKCdsaScpWzBdKQogICAgICB9CgogICAgICBuZXh0LmFkZENsYXNzKCdhY3RpdmUnKQogICAgfQoKICAsIHByZXY6IGZ1bmN0aW9uIChldmVudCkgewogICAgICB2YXIgYWN0aXZlID0gdGhpcy4kbWVudS5maW5kKCcuYWN0aXZlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpCiAgICAgICAgLCBwcmV2ID0gYWN0aXZlLnByZXYoKQoKICAgICAgaWYgKCFwcmV2Lmxlbmd0aCkgewogICAgICAgIHByZXYgPSB0aGlzLiRtZW51LmZpbmQoJ2xpJykubGFzdCgpCiAgICAgIH0KCiAgICAgIHByZXYuYWRkQ2xhc3MoJ2FjdGl2ZScpCiAgICB9CgogICwgbGlzdGVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuJGVsZW1lbnQKICAgICAgICAub24oJ2ZvY3VzJywgICAgJC5wcm94eSh0aGlzLmZvY3VzLCB0aGlzKSkKICAgICAgICAub24oJ2JsdXInLCAgICAgJC5wcm94eSh0aGlzLmJsdXIsIHRoaXMpKQogICAgICAgIC5vbigna2V5cHJlc3MnLCAkLnByb3h5KHRoaXMua2V5cHJlc3MsIHRoaXMpKQogICAgICAgIC5vbigna2V5dXAnLCAgICAkLnByb3h5KHRoaXMua2V5dXAsIHRoaXMpKQoKICAgICAgaWYgKHRoaXMuZXZlbnRTdXBwb3J0ZWQoJ2tleWRvd24nKSkgewogICAgICAgIHRoaXMuJGVsZW1lbnQub24oJ2tleWRvd24nLCAkLnByb3h5KHRoaXMua2V5ZG93biwgdGhpcykpCiAgICAgIH0KCiAgICAgIHRoaXMuJG1lbnUKICAgICAgICAub24oJ2NsaWNrJywgJC5wcm94eSh0aGlzLmNsaWNrLCB0aGlzKSkKICAgICAgICAub24oJ21vdXNlZW50ZXInLCAnbGknLCAkLnByb3h5KHRoaXMubW91c2VlbnRlciwgdGhpcykpCiAgICAgICAgLm9uKCdtb3VzZWxlYXZlJywgJ2xpJywgJC5wcm94eSh0aGlzLm1vdXNlbGVhdmUsIHRoaXMpKQogICAgfQoKICAsIGV2ZW50U3VwcG9ydGVkOiBmdW5jdGlvbihldmVudE5hbWUpIHsKICAgICAgdmFyIGlzU3VwcG9ydGVkID0gZXZlbnROYW1lIGluIHRoaXMuJGVsZW1lbnQKICAgICAgaWYgKCFpc1N1cHBvcnRlZCkgewogICAgICAgIHRoaXMuJGVsZW1lbnQuc2V0QXR0cmlidXRlKGV2ZW50TmFtZSwgJ3JldHVybjsnKQogICAgICAgIGlzU3VwcG9ydGVkID0gdHlwZW9mIHRoaXMuJGVsZW1lbnRbZXZlbnROYW1lXSA9PT0gJ2Z1bmN0aW9uJwogICAgICB9CiAgICAgIHJldHVybiBpc1N1cHBvcnRlZAogICAgfQoKICAsIG1vdmU6IGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmICghdGhpcy5zaG93bikgcmV0dXJuCgogICAgICBzd2l0Y2goZS5rZXlDb2RlKSB7CiAgICAgICAgY2FzZSA5OiAvLyB0YWIKICAgICAgICBjYXNlIDEzOiAvLyBlbnRlcgogICAgICAgIGNhc2UgMjc6IC8vIGVzY2FwZQogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICBicmVhawoKICAgICAgICBjYXNlIDM4OiAvLyB1cCBhcnJvdwogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICB0aGlzLnByZXYoKQogICAgICAgICAgYnJlYWsKCiAgICAgICAgY2FzZSA0MDogLy8gZG93biBhcnJvdwogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICB0aGlzLm5leHQoKQogICAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKQogICAgfQoKICAsIGtleWRvd246IGZ1bmN0aW9uIChlKSB7CiAgICAgIHRoaXMuc3VwcHJlc3NLZXlQcmVzc1JlcGVhdCA9IH4kLmluQXJyYXkoZS5rZXlDb2RlLCBbNDAsMzgsOSwxMywyN10pCiAgICAgIHRoaXMubW92ZShlKQogICAgfQoKICAsIGtleXByZXNzOiBmdW5jdGlvbiAoZSkgewogICAgICBpZiAodGhpcy5zdXBwcmVzc0tleVByZXNzUmVwZWF0KSByZXR1cm4KICAgICAgdGhpcy5tb3ZlKGUpCiAgICB9CgogICwga2V5dXA6IGZ1bmN0aW9uIChlKSB7CiAgICAgIHN3aXRjaChlLmtleUNvZGUpIHsKICAgICAgICBjYXNlIDQwOiAvLyBkb3duIGFycm93CiAgICAgICAgY2FzZSAzODogLy8gdXAgYXJyb3cKICAgICAgICBjYXNlIDE2OiAvLyBzaGlmdAogICAgICAgIGNhc2UgMTc6IC8vIGN0cmwKICAgICAgICBjYXNlIDE4OiAvLyBhbHQKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgOTogLy8gdGFiCiAgICAgICAgY2FzZSAxMzogLy8gZW50ZXIKICAgICAgICAgIGlmICghdGhpcy5zaG93bikgcmV0dXJuCiAgICAgICAgICB0aGlzLnNlbGVjdCgpCiAgICAgICAgICBicmVhawoKICAgICAgICBjYXNlIDI3OiAvLyBlc2NhcGUKICAgICAgICAgIGlmICghdGhpcy5zaG93bikgcmV0dXJuCiAgICAgICAgICB0aGlzLmhpZGUoKQogICAgICAgICAgYnJlYWsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRoaXMubG9va3VwKCkKICAgICAgfQoKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKQogICAgICBlLnByZXZlbnREZWZhdWx0KCkKICB9CgogICwgZm9jdXM6IGZ1bmN0aW9uIChlKSB7CiAgICAgIHRoaXMuZm9jdXNlZCA9IHRydWUKICAgIH0KCiAgLCBibHVyOiBmdW5jdGlvbiAoZSkgewogICAgICB0aGlzLmZvY3VzZWQgPSBmYWxzZQogICAgICBpZiAoIXRoaXMubW91c2Vkb3ZlciAmJiB0aGlzLnNob3duKSB0aGlzLmhpZGUoKQogICAgfQoKICAsIGNsaWNrOiBmdW5jdGlvbiAoZSkgewogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpCiAgICAgIGUucHJldmVudERlZmF1bHQoKQogICAgICB0aGlzLnNlbGVjdCgpCiAgICAgIHRoaXMuJGVsZW1lbnQuZm9jdXMoKQogICAgfQoKICAsIG1vdXNlZW50ZXI6IGZ1bmN0aW9uIChlKSB7CiAgICAgIHRoaXMubW91c2Vkb3ZlciA9IHRydWUKICAgICAgdGhpcy4kbWVudS5maW5kKCcuYWN0aXZlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpCiAgICAgICQoZS5jdXJyZW50VGFyZ2V0KS5hZGRDbGFzcygnYWN0aXZlJykKICAgIH0KCiAgLCBtb3VzZWxlYXZlOiBmdW5jdGlvbiAoZSkgewogICAgICB0aGlzLm1vdXNlZG92ZXIgPSBmYWxzZQogICAgICBpZiAoIXRoaXMuZm9jdXNlZCAmJiB0aGlzLnNob3duKSB0aGlzLmhpZGUoKQogICAgfQoKICB9CgoKICAvKiBUWVBFQUhFQUQgUExVR0lOIERFRklOSVRJT04KICAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIG9sZCA9ICQuZm4udHlwZWFoZWFkCgogICQuZm4udHlwZWFoZWFkID0gZnVuY3Rpb24gKG9wdGlvbikgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciAkdGhpcyA9ICQodGhpcykKICAgICAgICAsIGRhdGEgPSAkdGhpcy5kYXRhKCd0eXBlYWhlYWQnKQogICAgICAgICwgb3B0aW9ucyA9IHR5cGVvZiBvcHRpb24gPT0gJ29iamVjdCcgJiYgb3B0aW9uCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgndHlwZWFoZWFkJywgKGRhdGEgPSBuZXcgVHlwZWFoZWFkKHRoaXMsIG9wdGlvbnMpKSkKICAgICAgaWYgKHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycpIGRhdGFbb3B0aW9uXSgpCiAgICB9KQogIH0KCiAgJC5mbi50eXBlYWhlYWQuZGVmYXVsdHMgPSB7CiAgICBzb3VyY2U6IFtdCiAgLCBpdGVtczogOAogICwgbWVudTogJzx1bCBjbGFzcz0idHlwZWFoZWFkIGRyb3Bkb3duLW1lbnUiPjwvdWw+JwogICwgaXRlbTogJzxsaT48YSBocmVmPSIjIj48L2E+PC9saT4nCiAgLCBtaW5MZW5ndGg6IDEKICB9CgogICQuZm4udHlwZWFoZWFkLkNvbnN0cnVjdG9yID0gVHlwZWFoZWFkCgoKIC8qIFRZUEVBSEVBRCBOTyBDT05GTElDVAogICogPT09PT09PT09PT09PT09PT09PSAqLwoKICAkLmZuLnR5cGVhaGVhZC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgJC5mbi50eXBlYWhlYWQgPSBvbGQKICAgIHJldHVybiB0aGlzCiAgfQoKCiAvKiBUWVBFQUhFQUQgREFUQS1BUEkKICAqID09PT09PT09PT09PT09PT09PSAqLwoKICAkKGRvY3VtZW50KS5vbignZm9jdXMudHlwZWFoZWFkLmRhdGEtYXBpJywgJ1tkYXRhLXByb3ZpZGU9InR5cGVhaGVhZCJdJywgZnVuY3Rpb24gKGUpIHsKICAgIHZhciAkdGhpcyA9ICQodGhpcykKICAgIGlmICgkdGhpcy5kYXRhKCd0eXBlYWhlYWQnKSkgcmV0dXJuCiAgICAkdGhpcy50eXBlYWhlYWQoJHRoaXMuZGF0YSgpKQogIH0pCgp9KHdpbmRvdy5qUXVlcnkpOwovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIGJvb3RzdHJhcC1hZmZpeC5qcyB2Mi4zLjEKICogaHR0cDovL3R3aXR0ZXIuZ2l0aHViLmNvbS9ib290c3RyYXAvamF2YXNjcmlwdC5odG1sI2FmZml4CiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogQ29weXJpZ2h0IDIwMTIgVHdpdHRlciwgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCgohZnVuY3Rpb24gKCQpIHsKCiAgInVzZSBzdHJpY3QiOyAvLyBqc2hpbnQgO187CgoKIC8qIEFGRklYIENMQVNTIERFRklOSVRJT04KICAqID09PT09PT09PT09PT09PT09PT09PT0gKi8KCiAgdmFyIEFmZml4ID0gZnVuY3Rpb24gKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCAkLmZuLmFmZml4LmRlZmF1bHRzLCBvcHRpb25zKQogICAgdGhpcy4kd2luZG93ID0gJCh3aW5kb3cpCiAgICAgIC5vbignc2Nyb2xsLmFmZml4LmRhdGEtYXBpJywgJC5wcm94eSh0aGlzLmNoZWNrUG9zaXRpb24sIHRoaXMpKQogICAgICAub24oJ2NsaWNrLmFmZml4LmRhdGEtYXBpJywgICQucHJveHkoZnVuY3Rpb24gKCkgeyBzZXRUaW1lb3V0KCQucHJveHkodGhpcy5jaGVja1Bvc2l0aW9uLCB0aGlzKSwgMSkgfSwgdGhpcykpCiAgICB0aGlzLiRlbGVtZW50ID0gJChlbGVtZW50KQogICAgdGhpcy5jaGVja1Bvc2l0aW9uKCkKICB9CgogIEFmZml4LnByb3RvdHlwZS5jaGVja1Bvc2l0aW9uID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzLiRlbGVtZW50LmlzKCc6dmlzaWJsZScpKSByZXR1cm4KCiAgICB2YXIgc2Nyb2xsSGVpZ2h0ID0gJChkb2N1bWVudCkuaGVpZ2h0KCkKICAgICAgLCBzY3JvbGxUb3AgPSB0aGlzLiR3aW5kb3cuc2Nyb2xsVG9wKCkKICAgICAgLCBwb3NpdGlvbiA9IHRoaXMuJGVsZW1lbnQub2Zmc2V0KCkKICAgICAgLCBvZmZzZXQgPSB0aGlzLm9wdGlvbnMub2Zmc2V0CiAgICAgICwgb2Zmc2V0Qm90dG9tID0gb2Zmc2V0LmJvdHRvbQogICAgICAsIG9mZnNldFRvcCA9IG9mZnNldC50b3AKICAgICAgLCByZXNldCA9ICdhZmZpeCBhZmZpeC10b3AgYWZmaXgtYm90dG9tJwogICAgICAsIGFmZml4CgogICAgaWYgKHR5cGVvZiBvZmZzZXQgIT0gJ29iamVjdCcpIG9mZnNldEJvdHRvbSA9IG9mZnNldFRvcCA9IG9mZnNldAogICAgaWYgKHR5cGVvZiBvZmZzZXRUb3AgPT0gJ2Z1bmN0aW9uJykgb2Zmc2V0VG9wID0gb2Zmc2V0LnRvcCgpCiAgICBpZiAodHlwZW9mIG9mZnNldEJvdHRvbSA9PSAnZnVuY3Rpb24nKSBvZmZzZXRCb3R0b20gPSBvZmZzZXQuYm90dG9tKCkKCiAgICBhZmZpeCA9IHRoaXMudW5waW4gIT0gbnVsbCAmJiAoc2Nyb2xsVG9wICsgdGhpcy51bnBpbiA8PSBwb3NpdGlvbi50b3ApID8KICAgICAgZmFsc2UgICAgOiBvZmZzZXRCb3R0b20gIT0gbnVsbCAmJiAocG9zaXRpb24udG9wICsgdGhpcy4kZWxlbWVudC5oZWlnaHQoKSA+PSBzY3JvbGxIZWlnaHQgLSBvZmZzZXRCb3R0b20pID8KICAgICAgJ2JvdHRvbScgOiBvZmZzZXRUb3AgIT0gbnVsbCAmJiBzY3JvbGxUb3AgPD0gb2Zmc2V0VG9wID8KICAgICAgJ3RvcCcgICAgOiBmYWxzZQoKICAgIGlmICh0aGlzLmFmZml4ZWQgPT09IGFmZml4KSByZXR1cm4KCiAgICB0aGlzLmFmZml4ZWQgPSBhZmZpeAogICAgdGhpcy51bnBpbiA9IGFmZml4ID09ICdib3R0b20nID8gcG9zaXRpb24udG9wIC0gc2Nyb2xsVG9wIDogbnVsbAoKICAgIHRoaXMuJGVsZW1lbnQucmVtb3ZlQ2xhc3MocmVzZXQpLmFkZENsYXNzKCdhZmZpeCcgKyAoYWZmaXggPyAnLScgKyBhZmZpeCA6ICcnKSkKICB9CgoKIC8qIEFGRklYIFBMVUdJTiBERUZJTklUSU9OCiAgKiA9PT09PT09PT09PT09PT09PT09PT09PSAqLwoKICB2YXIgb2xkID0gJC5mbi5hZmZpeAoKICAkLmZuLmFmZml4ID0gZnVuY3Rpb24gKG9wdGlvbikgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciAkdGhpcyA9ICQodGhpcykKICAgICAgICAsIGRhdGEgPSAkdGhpcy5kYXRhKCdhZmZpeCcpCiAgICAgICAgLCBvcHRpb25zID0gdHlwZW9mIG9wdGlvbiA9PSAnb2JqZWN0JyAmJiBvcHRpb24KICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCdhZmZpeCcsIChkYXRhID0gbmV3IEFmZml4KHRoaXMsIG9wdGlvbnMpKSkKICAgICAgaWYgKHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycpIGRhdGFbb3B0aW9uXSgpCiAgICB9KQogIH0KCiAgJC5mbi5hZmZpeC5Db25zdHJ1Y3RvciA9IEFmZml4CgogICQuZm4uYWZmaXguZGVmYXVsdHMgPSB7CiAgICBvZmZzZXQ6IDAKICB9CgoKIC8qIEFGRklYIE5PIENPTkZMSUNUCiAgKiA9PT09PT09PT09PT09PT09PSAqLwoKICAkLmZuLmFmZml4Lm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICAkLmZuLmFmZml4ID0gb2xkCiAgICByZXR1cm4gdGhpcwogIH0KCgogLyogQUZGSVggREFUQS1BUEkKICAqID09PT09PT09PT09PT09ICovCgogICQod2luZG93KS5vbignbG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICQoJ1tkYXRhLXNweT0iYWZmaXgiXScpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgJHNweSA9ICQodGhpcykKICAgICAgICAsIGRhdGEgPSAkc3B5LmRhdGEoKQoKICAgICAgZGF0YS5vZmZzZXQgPSBkYXRhLm9mZnNldCB8fCB7fQoKICAgICAgZGF0YS5vZmZzZXRCb3R0b20gJiYgKGRhdGEub2Zmc2V0LmJvdHRvbSA9IGRhdGEub2Zmc2V0Qm90dG9tKQogICAgICBkYXRhLm9mZnNldFRvcCAmJiAoZGF0YS5vZmZzZXQudG9wID0gZGF0YS5vZmZzZXRUb3ApCgogICAgICAkc3B5LmFmZml4KGRhdGEpCiAgICB9KQogIH0pCgoKfSh3aW5kb3cualF1ZXJ5KTsKLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KalF1ZXJ5KGZ1bmN0aW9uKCl7CiAgICAgIC8valF1ZXJ5KCcuc2YtbWVudScpLm1vYmlsZU1lbnUoKTsKICAgIH0pCiQoZnVuY3Rpb24oKXsKLy8gSVBhZC9JUGhvbmUKICB2YXIgdmlld3BvcnRtZXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvciAmJiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtZXRhW25hbWU9InZpZXdwb3J0Il0nKSwKICAgIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKIAogICAgZ2VzdHVyZVN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZpZXdwb3J0bWV0YS5jb250ZW50ID0gIndpZHRoPWRldmljZS13aWR0aCwgbWluaW11bS1zY2FsZT0wLjI1LCBtYXhpbXVtLXNjYWxlPTEuNiI7CiAgICB9LAogCiAgICBzY2FsZUZpeCA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHZpZXdwb3J0bWV0YSAmJiAvaVBob25lfGlQYWQvLnRlc3QodWEpICYmICEvT3BlcmEgTWluaS8udGVzdCh1YSkpIHsKICAgICAgICB2aWV3cG9ydG1ldGEuY29udGVudCA9ICJ3aWR0aD1kZXZpY2Utd2lkdGgsIG1pbmltdW0tc2NhbGU9MS4wLCBtYXhpbXVtLXNjYWxlPTEuMCI7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiZ2VzdHVyZXN0YXJ0IiwgZ2VzdHVyZVN0YXJ0LCBmYWxzZSk7CiAgICAgIH0KICAgIH07CnNjYWxlRml4KCk7CgovLyBNZW51IEFuZHJvaWQKaWYod2luZG93Lm9yaWVudGF0aW9uIT11bmRlZmluZWQpewogdmFyIHJlZ00gPSAvaXBvZHxpcGFkfGlwaG9uZS9naSwKICByZXN1bHQgPSB1YS5tYXRjaChyZWdNKQogaWYoIXJlc3VsdCkgewogICQoJy5zZi1tZW51IGxpJykuZWFjaChmdW5jdGlvbigpewoKICAgaWYoJCgiPnVsIiwgdGhpcylbMF0pewogICAgJCgiPmEiLCB0aGlzKS50b2dnbGUoCiAgICAgZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgIH0sCiAgICAgZnVuY3Rpb24oKXsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSAkKHRoaXMpLmF0dHIoImhyZWYiKTsKICAgICB9CiAgICApOwogICB9IAogIH0pCiB9Cn0KfSk7Ci8qIC0tLS0tLSBmaSBmaXhlZCBwb3NpdGlvbiBvbiBBbmRyb2lkIC0tLS0tKi8KdmFyIHVhPW5hdmlnYXRvci51c2VyQWdlbnQudG9Mb2NhbGVMb3dlckNhc2UoKSwKIHJlZ1YgPSAvaXBvZHxpcGFkfGlwaG9uZS9naSwKIHJlc3VsdCA9IHVhLm1hdGNoKHJlZ1YpLAogdXNlclNjYWxlPSIiOwppZighcmVzdWx0KXsKIHVzZXJTY2FsZT0iLHVzZXItc2NhbGFibGU9MCIKfQpkb2N1bWVudC53cml0ZSgnPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCxpbml0aWFsLXNjYWxlPTEuMCcrdXNlclNjYWxlKyciPicpCi8qLS0tLS0tLS0tLS0tLS0qLw==" jcr:lastModified="2015-05-29T17:20:16.917+07:00" jcr:mimeType="application/x-javascript"/></bootstrap.js>